---
Title: "Main"
Author: "Thomas Verliefde"
Date: "2019/06/09"
Output: html_document
editor_options:
  chunk_output_type: console
Version: '1.0'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# rm(list=ls())

# load("20190523.RData")

# save.image("20190523.RData")
```

```{r libraries, include=FALSE}

lapply(
  c("plyr","dplyr","tidyr","ggplot2","readr","lme4","afex","lmerTest","emmeans",
    "pbkrtest","purrr","magrittr","cowplot","parallel"),
  require,
  character.only=T
)

```

#######################
# Importing & Cleanup
#######################

###########
## Import
###########

The required datafile (Data_RelAmb02.zip) should be in the working directory.
Note that this datafile is not public on GitHub, but will be on the OSF page of this project.

```{r RAW import, options}

temp <- tempdir()
RAW <- "dataRelAmb02.zip" %>% {
  ldply(
    .data = unzip(.,list=T) %>% # create a list of all the files/folders in the zip
      filter(grepl(".+(csv)$",.$Name)) %>% # ignore any files/folders without .csv extension
      arrange(Name %>% desc) %$% Name, # Return only the relevant .csv filenames
    .fun = function(x) {
      unzip(.,files=x,exdir=temp) %>% # Get for each of the .csv filenames the relevant file, and temporary save it
        read_csv(n_max = 1) # Import the .csv file to R
    }
  )
}
rm(temp)

```

######################
## Technical Issues
######################

Subjects 1, 82, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97 have data from during a period in which the software caused problems.
Subjects 83, 84, 85 have no data since the software issue was unresolved at the time.
Subjects 87, 90, 92, 94, 95, 96, & 97 are semi-problematic, as they do not have any direct measures recorded.
The data for latencies is complete though, and can be used for latency analyses.
Further, Subject 87 does not have fully-correct demographics.
That is why their age is indicated as 99 and their study is unknown. Their gender and language are correct though.

Subject 161: ambiSuggestions
Subject 152: Objects_Pos1,Objects_Pos2,Others,Demo,Time
Subject 149: ambiSuggestions
Subject 145: Others_Pos2,Demo,Time
Subject 102: ambiSuggestions

Subjects 152 and 145 are missing all demographics.
The ambiSuggestions variable missing is no issue for this exp.

Subject 107 apparently performed the experiment twice. Only the results from the first experiment will be used.
This is ensured during the import of the data by specifying "n_max = 1".

```{r NA in RAW, exclude=TRUE}

# naRAW <- RAW %>%
#   select(
#     grep("^(Objects).+(Num)$",names(.),invert=TRUE)
#   ) %>%
#   filter_all(any_vars(is.na(.))) %>%
#   group_by(Subject,Condition,Key,firstBlock,firstValence) %>%
#   select_if(function(x) any(is.na(x))) %>%
#   ungroup
#     
# naRAW %>%
#   select(Subject,Condition,Key,firstBlock,firstValence)
# 
# naRAW %>% utils::View(.)

```




```{r RAW - Wrangling, options}

RAW %<>%
  mutate_at(
    vars(Age,Handedness,Study,ambiSuggestions),
    funs(
      case_when(
        Subject == 87 ~ NA_character_,
        TRUE ~ .
      )
    )
  ) %>%
  as_tibble %>%
  select(
    -matches("^(practice|experiment)(Primes|Trials)(Objects|Others)$"),
    -hostName
  ) %>%
  mutate(
    Subject = Subject %>% as.numeric %>% factor(levels = unique(.) %>% sort),
    Age = Age %>% as.numeric
  )

```

###############
## Wrangling
###############

```{r Trials - Wrangling, options}

dfTrials <- RAW %>%
  gather(
    "fullTrials",
    "outputTrials",
    matches("^(practice|experiment)_(Objects|Others)(\\d)+_(answer|time|prime|target)(Cat)?")
  ) %>%
  select(Subject,Condition,Key,firstBlock,firstValence,fullTrials,outputTrials) %>%
  tidyr::extract(
    fullTrials,
    c("Segment","Block","Trial","components"),
    "^(practice|experiment)_(Objects|Others)(\\d+)_(\\D+)$"
  ) %>%
  group_by(Subject,Trial,Segment,Block) %>%
  spread(
    components,
    outputTrials
  ) %>%
  ungroup %>%
  rename(
    Response = answer,
    primeWord = prime,
    primeCondition = primeCat,
    targetWord = target,
    targetCondition = targetCat,
    RT = time
  ) %>%
  mutate(
    Trial = Trial %>% as.numeric %>% factor(levels = unique(.) %>% sort),
    primeCondition = primeCondition %>%
      recode(
        "0" = "nounPos",
        "1" = "nounNeg",
        "2" = paste0(tolower(Block),"Pos"),
        "3" = paste0(tolower(Block),"Neg"),
        "4" = "letterStr"
      ), # The following two variables could be created with an tidyr::extract(primeCondition,c("primeValence","primeSource"),"^(.+)([A-Z]{1}.+)$")
    primeValence = primeCondition %>%
      gsub("^(.+)([A-Z]{1}.+)$","\\2",.),
    primeSource = primeCondition %>%
      gsub("^(.+)([A-Z]{1}.+)$","\\1",.),
    targetCondition = targetCondition %>%
      recode_factor(
        "0" = "Pos",
        "1" = "Neg"
      ),
    Congruency = case_when(
      primeValence == targetCondition ~ "Congruent",
      primeValence == "Str" ~ "Base",
      TRUE ~ "Incongruent"
    ),
    RT = RT %>% as.numeric,
    logRT = RT %>% as.numeric %>% log,
    Correct = case_when(
      Response == "A" & targetCondition == "Pos" & Key == "Apos" ~ TRUE,
      Response == "A" & targetCondition == "Neg" & Key == "Aneg" ~ TRUE,
      Response == "L" & targetCondition == "Neg" & Key == "Apos" ~ TRUE,
      Response == "L" & targetCondition == "Pos" & Key == "Aneg" ~ TRUE,
      TRUE ~ FALSE
    )
  ) %>%
  group_by(Subject,Segment) %>%
  mutate(
    Accuracy = mean(Correct),
    latencyInclusion = (RT >= 300 & RT <= 3000),
    trialInclusion = latencyInclusion & Correct,
    accInclusion = (1 - mean(trialInclusion)) < 0.83,
    nameExclusion = Subject %in% c(145,152),
    subjExclusion = not(accInclusion) | nameExclusion,
    Inclusion = trialInclusion & not(subjExclusion) & Segment == "experiment"
  ) %>%
  ungroup %>%
  arrange(Subject,Block,desc(Segment),Trial)

```

```{r Direct - Wrangling, options}

dfDirect <- RAW %>%
  gather(
    "fullDirect",
    "outputDirect",
    matches("^(Objects|Others)_(Neg|Pos)(1|2)_(Dir|Num|Rel)_?(Amb|Neg|Pos)?"),
    matches("^(collect)(Objects|Others)(Neg|Pos)(1|2)$")
  ) %>% 
  select(Subject,Condition,Key,firstBlock,firstValence,fullDirect,outputDirect) %>%
  mutate(
    fullDirect = sub("(_)|(collect)","",fullDirect)
  ) %>%
  separate(
    fullDirect,
    c("Item","Measure"),
    "_",
    extra = "merge",
    fill = "right"
  ) %>%
  replace_na(list(Measure = "Name")) %>%
  group_by(Subject,Item) %>%
  spread(Measure,outputDirect) %>%
  ungroup %>%
  tidyr::extract(
    Item,
    c("Type","Valence","Id"),
    "^(Objects|Others)(Pos|Neg)(1|2)$"
  ) %>%
  mutate(
    Num = case_when(
      Type == "Objects" ~ NA_character_,
      TRUE ~ Num),
    Dir_Pos = Dir_Pos %>% as.numeric,
    Dir_Neg = Dir_Neg %>% as.numeric,
    Dir_Amb = Dir_Amb %>% as.numeric,
    Griffin = (Dir_Pos + Dir_Neg) / 2 - abs(Dir_Pos - Dir_Neg)
  ) %>%
  rename(
    "Felt" = Dir_Amb,
    "Negative" = Dir_Neg,
    "Positive" = Dir_Pos,
    "Number" = Num,
    "Relation" = Rel
  ) %>%
  left_join(
    dfTrials %>% distinct(Subject,nameExclusion,subjExclusion),
    by=c("Subject")
  )
  
```

```{r Time - Wrangling, options}

dfTime <- RAW %>%
  gather(
    "fullTime",
    "outputTime",
    matches("^(time)")
  ) %>%
  select(Subject,Condition,Key,firstBlock,firstValence,fullTime,outputTime) %>%
  mutate(
    fullTime = gsub("time","",fullTime),
    Order = fullTime %>%
      recode(
        "Collect01" = 1,
        "Practice01" = 2 ,
        "Experiment01" = 3,
        "Collect02" = 4,
        "Practice02" = 5,
        "Experiment02" = 6,
        "Explicit" = 7,
        "Demographics" = 8,
        "Ambi" = 9,
        "Total" = 10
      )
  ) %>%
  select(Subject,Order,"Part"=fullTime,"Time"=outputTime) %>%
  arrange(Subject,Order) %>%
  left_join(
    dfTrials %>% distinct(Subject,nameExclusion,subjExclusion),
    by=c("Subject")
  )

```

```{r Demo - Wrangling, options}

dfDemo <- RAW %>%
  select(Subject,Condition,Key,firstBlock,firstValence,Age,Gender,Language,Handedness,Study,ambiSuggestions) %>%
  left_join(
    dfTrials %>% distinct(Subject,nameExclusion,subjExclusion),
    by=c("Subject")
  )

```

###########
## Output
###########

```{r Dataframe Output, exclude=TRUE}

# dfTrials %>%
#   write.csv("trialsData190611.csv")
# 
# dfTime %>%
#   write.csv("timeData190611.csv")
# 
# dfDirect %>%
#   write.csv("directData190611.csv")
# 
# dfDemo %>%
#   write.csv("demoData190611.csv")

```


##########
# Demo+
##########

```{r Balance, options}

dfDemo %>%
  count(Condition,Key,firstBlock,firstValence)

dfDemo %>%
  filter(subjExclusion %>% not) %>%
  count(Condition,Key,firstBlock,firstValence)

dfDemo %>%
  filter(subjExclusion %>% not) %>%
  count(Key)

dfDemo %>%
  filter(subjExclusion %>% not) %>%
  count(firstBlock)

dfDemo %>%
  filter(subjExclusion %>% not) %>%
  count(firstValence)

dfDemo %$%
   `%in%`(c(81:160),Subject) %>%
  not %>%
  magrittr::extract(c(81:160),.)

```

```{r Demos, options}

dfDemo %>%
  summarize_at(
    "Age",
    funs(mean,sd,min,max,median),
    na.rm = TRUE
  )

```

############
# Analyses
############


#####################
## Multilevel Model
#####################

Possibility:
set contrasts of the primeCondition to treatment (with the letter strings as base), but
with contrasts for targetCondition to [-1, 1] for Neg and Pos respectively.

```{r Random Intercepts subject & target, options}

afex::set_effects_contrasts()
fitBoth1 <- dfTrials %>%
  filter(Inclusion) %>% {
    mixed(
      logRT ~ primeCondition * targetCondition + Block + (1|targetWord) + (1|Subject),
      data = .,
      method = "S"
    )
  }

afex::set_effects_contrasts()
fitBoth2 <- dfTrials %>%
  filter(Inclusion) %>% {
    mixed(
      logRT ~ primeCondition * targetCondition + (1|Block) + (1|targetWord) + (1|Subject),
      data = .,
      method = "S"
    )
  }

afex::set_effects_contrasts()
fitObj <- dfTrials %>%
  filter(Inclusion & Block == "Objects") %>% {
    mixed(
      logRT ~ primeCondition * targetCondition + (1|targetWord) + (1|Subject),
      data = .,
      method = "S"
    )
  }

afex::set_effects_contrasts()
fitOth <- dfTrials %>%
  filter(Inclusion & Block == "Others") %>% {
    mixed(
      logRT ~ primeCondition * targetCondition + (1|targetWord) + (1|Subject),
      data = .,
      method = "S"
    )
  }


```

```{r Estimated Means, options}

emmeansFull1 <- fitBoth1 %>% emmeans(~primeCondition * targetCondition + Block)

emmeansFull2 <- fitBoth2 %>% emmeans(~primeCondition * targetCondition)

emmeansObj <- fitObj %>% emmeans(~primeCondition * targetCondition)

emmeansOth <- fitOth %>% emmeans(~primeCondition * targetCondition)

```

```{r Contrasts, options}

contrFull1 <- emmeansFull1 %>%
  contrast(method="revpairwise") %>%
  as_tibble %>%
  separate(contrast,c("contrastA","contrastB"),sep=" - ") %>%
  separate(contrastA,c("primeA","targetA","blockA"),sep=",") %>%
  separate(contrastB,c("primeB","targetB","blockB"),sep=",") %>%
  mutate_at(
    vars(primeA,primeB),
    funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE)))
  ) %>%
  mutate_at(
    vars(targetA,targetB),
    funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE)))
  ) %>%
  arrange(blockA,blockB,primeA %>% desc,primeB %>% desc,targetA)

contrFull2 <- emmeansFull2 %>%
  contrast(method="revpairwise") %>%
  as_tibble %>%
  separate(contrast,c("contrastA","contrastB"),sep=" - ") %>%
  separate(contrastA,c("primeA","targetA"),sep=",") %>%
  separate(contrastB,c("primeB","targetB"),sep=",") %>%
  mutate_at(
    vars(primeA,primeB),
    funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE)))
  ) %>%
  mutate_at(
    vars(targetA,targetB),
    funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE)))
  ) %>%
  arrange(primeA %>% desc,primeB %>% desc,targetA)

contrObj <- emmeansObj %>%
  contrast(method="pairwise") %>%
  as_tibble %>%
  separate(contrast,c("contrastA","contrastB"),sep=" - ") %>%
  separate(contrastA,c("primeA","targetA"),sep=",") %>%
  separate(contrastB,c("primeB","targetB"),sep=",") %>%
  mutate_at(
    vars(primeA,primeB),
    funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE)))
  ) %>%
  mutate_at(
    vars(targetA,targetB),
    funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE)))
  ) %>%
  arrange(primeA,primeB,targetA)

contrOth <- emmeansOth %>%
  contrast(method="pairwise") %>%
  as_tibble %>%
  separate(contrast,c("contrastA","contrastB"),sep=" - ") %>%
  separate(contrastA,c("primeA","targetA"),sep=",") %>%
  separate(contrastB,c("primeB","targetB"),sep=",") %>%
  mutate_at(
    vars(primeA,primeB),
    funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE)))
  ) %>%
  mutate_at(
    vars(targetA,targetB),
    funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE)))
  ) %>%
  arrange(primeA,primeB,targetA)

```

#############
### Graphs
#############

```{r Emmeans Others & Objects, options}

plot_grid(
  emmeansOth %>%
    as_tibble %>%
    mutate_at(
      vars(emmean,asymp.LCL,asymp.UCL),
      exp
    ) %>%
    mutate(
      primeCondition = primeCondition %>%
        as.factor %>%
        factor(levels = levels(.) %>% rev)
    ) %>%
    ggplot(aes(x = primeCondition, y = emmean, fill = targetCondition, ymin = asymp.LCL, ymax = asymp.UCL)) +
    geom_col(position=position_dodge2()) +
    labs(x="Prime Conditions",y="Latency (ms)",title=paste("Comparison Estimated Mean Latency for the Others Block")) +
    guides(fill = guide_legend(title="Target\nValence")) +
    scale_fill_discrete(labels=c("Positive","Negative")) +
    geom_errorbar(position = position_dodge2(padding=.8),colour = "black",size=.5) +
    geom_label(
      data = contrOth %>%
        filter(primeA == primeB),
      aes(
        x = primeA,
        y = 10,
        label = p.value %>% signif(3)
      ),
      inherit.aes = FALSE
    ) +
    theme_bw(),
  emmeansObj %>%
    as_tibble %>%
    mutate_at(
      vars(emmean,asymp.LCL,asymp.UCL),
      exp
    ) %>%
    mutate(
      primeCondition = primeCondition %>%
        as.factor %>%
        factor(levels = levels(.) %>% rev)
    ) %>%
    ggplot(aes(x = primeCondition, y = emmean, fill = targetCondition, ymin = asymp.LCL, ymax = asymp.UCL)) +
    geom_col(position=position_dodge2()) +
    labs(x="Prime Conditions",y="Latency (ms)",title=paste("Comparison Estimated Mean Latency for the Objects Block")) +
    guides(fill = guide_legend(title="Target\nValence")) +
    scale_fill_discrete(labels=c("Positive","Negative")) +
    geom_errorbar(position = position_dodge2(padding=.8),colour = "black",size=.5) +
    geom_label(
      data = contrObj %>%
        filter(primeA == primeB),
      aes(
        x = primeA,
        y = 10,
        label = p.value %>% signif(3)
      ),
      inherit.aes = FALSE
    ) +
    theme_bw(),
  ncol = 1,
  align = "hv"
)

```

```{r Comparison Others & Objects, options}

contrFull2 %>%
  filter(
    grepl("others.",primeA) & grepl("objects.",primeB) & targetA == targetB
  ) %>% 
  group_by(primeA,primeB) %>%
  do(
    plots = ggplot(data=.,aes(x=primeA,y=estimate,fill=targetA)) +
      geom_col(position=position_dodge2()) +
      ggtitle(paste(.$primeA,"-",.$primeB)) +
      labs(x="",y="") +
      scale_x_discrete(labels = NULL, breaks = NULL) +
      scale_y_continuous(limits=c(-.08,.08)) +
      geom_label(
         aes(
           y=0,
          label=case_when(
            p.value < .001 ~ '***',
            p.value < .01 ~ '**',
            p.value < .05 ~ '*',
            TRUE ~ signif(p.value,3) %>% as.character
          )
      ),
      position = position_dodge2(width=.9),
      show.legend=FALSE
      )
  ) %$% 
  plot_grid(
    plot_grid(
      plots[[1]] +
        theme(legend.position="none"),
      plots[[2]] +
        theme(legend.position="none"),
      plots[[3]] +
        theme(legend.position="none"),
      plots[[4]] +
        theme(legend.position="none"),
      align="hv",nrow=2
    ),
    get_legend(plots[[1]]),
    nrow=1,
    rel_widths = c(1,.2)
  )
  

```


```{r Graphs, options}

# contrFull1 %>%
#   filter(
#     targetA == targetB &
#       blockA == blockB
#   ) %>%
#   filter(
#     grepl("(others|objects).",primeA) |
#       grepl("(others|objects).",primeB)
#   ) %>%
#   filter(
#     (blockA == "Objects" & not(grepl("others.",primeA))) |
#       (blockB == "Objects" & not(grepl("others.",primeB)))
#   ) %>%
#   group_by(blockA,primeA,primeB) %>%
#   do(
#     plots = ggplot(data=.,aes(x=primeA,y=estimate,fill=targetA)) +
#       geom_col(position=position_dodge2()) +
#       ggtitle(paste(.$primeA,"-",.$primeB)) +
#       labs(x="",y="") +
#       scale_x_discrete(labels = NULL, breaks = NULL) +
#       scale_y_continuous() +
#       geom_label(
#          aes(
#           label=case_when(
#             p.value < .001 ~ '***',
#             p.value < .01 ~ '**',
#             p.value < .05 ~ '*',
#             TRUE ~ NA_character_
#           )
#       ),
#       position = position_dodge2(width=.9)
#       ) +
#       theme_bw(legend.position="none")
#   ) %$%
#   plot_grid(
#     plotlist=plots,align="hv"
#   )


```