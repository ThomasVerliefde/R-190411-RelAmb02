---
Title: "Main"
Author: "Thomas Verliefde"
Date: "2019/06/03"
Output: html_document
editor_options:
  chunk_output_type: console
Version: '0.8'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# rm(list=ls())

# load("20190523.RData")

# save.image("20190523.RData")
```

```{r libraries, include=FALSE}

lapply(
  c("plyr","dplyr","tidyr","ggplot2","readr","lme4","afex","lmerTest","emmeans",
    "pbkrtest","purrr","magrittr","cowplot","parallel"),
  require,
  character.only=T
)

```

#######################
# Importing & Cleanup
#######################

###########
## Import
###########

The required datafile (Data_RelAmb02.zip) should be in the working directory.
Note that this datafile is not public on GitHub, but will be on the OSF page of this project.

```{r RAW import, options}

temp <- tempdir()
RAW <- "partialData_RelAmb02.zip" %>% {
  ldply(
    .data = unzip(.,list=T) %>% # create a list of all the files/folders in the zip
      filter(grepl(".+(csv)$",.$Name)) %>% # ignore any files/folders without .csv extension
      arrange(Name %>% desc) %$% Name, # Return only the relevant .csv filenames
    .fun = function(x) {
      unzip(.,files=x,exdir=temp) %>% # Get for each of the .csv filenames the relevant file, and temporary save it
        read_csv(n_max = 1) # Import the .csv file to R
    }
  )
}
rm(temp)

```

######################
## Technical Issues
######################

Subjects 1, 82, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97 have data from during a period in which the software caused problems.
Subjects 83, 84, 85 have no data since the software issue was unresolved at the time.
Subjects 87, 90, 92, 94, 95, 96, & 97 are problematic, as they do not have any direct measures recorded.
The data for latencies is complete though, and can be used for latency analyses.
Further, Subject 87 does not have fully-correct demographics.
That is why their age is indicated as 99 and their study is unknown. Their gender and Language is correct though.

Unrelated:
Subject 145 has no values for some end-of-experiment variables, including one set of direct measures and full demographics.
Subject 107 apparently performed the experiment twice. Only the results from the first experiment will be used.
This is ensured during the import of the data by specifying "n_max = 1".

```{r RAW Problems, exclude=TRUE}

# temp <- tempdir()
# problemsRAW <- "partialData_RelAmb02.zip" %>% {
#   ldply(
#     .data = unzip(.,list=T) %>% # unzip the 
#       filter(grepl("^(oldVersion)/.+(csv)$",.$Name)) %>% # Ignore any file/folder that is not a .csv file
#       arrange(Name %>% desc) %$% Name, # Returns a 'list' containing the relevant .csv filenames
#     .fun = function(x) unzip(.,files=x,exdir=temp) %>% read_csv
#   )
# }
# rm(temp)
#
# problemsRAW %>%
#   filter(is.na(Objects_Neg1_Dir_Amb)) %>%
#   select(Subject,Condition,Key,firstBlock,firstValence)
# 
# problemsRAW %>% utils::View(.)

```

```{r RAW - Wrangling, options}

problemSubjects <- c(87,90,92,94,95,96,97,145)

RAW %<>%
  mutate_at(
    vars(Age,Handedness,Study,ambiSuggestions),
    funs(
      case_when(
        Subject == 87 ~ NA_character_,
        TRUE ~ .
      )
    )
  ) %>%
  as_tibble %>%
  select(
    -matches("^(practice|experiment)(Primes|Trials)(Objects|Others)$"),
    -hostName
  ) %>%
  mutate(
    Subject = Subject %>% as.numeric %>% factor(levels = unique(.) %>% sort)
  )

```

###############
## Wrangling
###############

```{r Trials - Wrangling, options}

dfTrials <- RAW %>%
  gather(
    "fullTrials",
    "outputTrials",
    matches("^(practice|experiment)_(Objects|Others)(\\d)+_(answer|time|prime|target)(Cat)?")
  ) %>%
  select(Subject,Condition,Key,firstBlock,firstValence,fullTrials,outputTrials) %>%
  tidyr::extract(
    fullTrials,
    c("Segment","Block","Trial","components"),
    "^(practice|experiment)_(Objects|Others)(\\d+)_(\\D+)$"
  ) %>%
  group_by(Subject,Trial,Segment,Block) %>%
  spread(
    components,
    outputTrials
  ) %>%
  ungroup %>%
  rename(
    Response = answer,
    primeWord = prime,
    primeCondition = primeCat,
    targetWord = target,
    targetCondition = targetCat,
    RT = time
  ) %>%
  mutate(
    Trial = Trial %>% as.numeric %>% factor(levels = unique(.) %>% sort),
    primeCondition = primeCondition %>%
      recode(
        "0" = "nounPos",
        "1" = "nounNeg",
        "2" = paste0(tolower(Block),"Pos"),
        "3" = paste0(tolower(Block),"Neg"),
        "4" = "letterStr",
      ), # The following two variables could be created with an tidyr::extract(primeCondition,c("primeValence","primeSource"),"^(.+)([A-Z]{1}.+)$")
    primeValence = primeCondition %>%
      gsub("^(.+)([A-Z]{1}.+)$","\\2",.),
    primeSource = primeCondition %>%
      gsub("^(.+)([A-Z]{1}.+)$","\\1",.),
    targetCondition = targetCondition %>%
      recode(
        "0" = "Pos",
        "1" = "Neg"
      ),
    Congruency = case_when(
      primeValence == targetCondition ~ "Congruent",
      primeValence == "Str" ~ "Base",
      TRUE ~ "Incongruent"
    ),
    RT = RT %>% as.numeric,
    logRT = RT %>% as.numeric %>% log,
    Correct = case_when(
      Response == "A" & targetCondition == "Pos" & Key == "Apos" ~ TRUE,
      Response == "A" & targetCondition == "Neg" & Key == "Aneg" ~ TRUE,
      Response == "L" & targetCondition == "Neg" & Key == "Apos" ~ TRUE,
      Response == "L" & targetCondition == "Pos" & Key == "Aneg" ~ TRUE,
      TRUE ~ FALSE
    )
  ) %>%
  group_by(Subject,Segment) %>%
  mutate(
    Accuracy = mean(Correct),
    latencyInclusion = (RT >= 300 & RT <= 3000),
    trialInclusion = latencyInclusion & Correct,
    accInclusion = (1 - mean(trialInclusion)) < 0.83,
    nameExclusion = FALSE,
    subjExclusion = not(accInclusion) | nameExclusion,
    Inclusion = trialInclusion & not(subjExclusion)
  ) %>%
  filter(Segment == "experiment") %>%
  ungroup %>%
  mutate_at(
    vars(primeCondition,targetCondition,primeValence,primeSource,Congruency),
    funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE)))
  ) %>%
  arrange(Subject,Block,Trial)

```

```{r Direct - Wrangling, options}

dfDirect <- RAW %>%
  gather(
    "fullDirect",
    "outputDirect",
    matches("^(Objects|Others)_(Neg|Pos)(1|2)_(Dir|Num|Rel)_?(Amb|Neg|Pos)?"),
    matches("^(collect)(Objects|Others)(Neg|Pos)(1|2)$")
  ) %>% 
  select(Subject,Condition,Key,firstBlock,firstValence,fullDirect,outputDirect) %>%
  mutate(
    fullDirect = sub("(_)|(collect)","",fullDirect)
  ) %>%
  separate(
    fullDirect,
    c("Item","Key"),
    "_",
    extra = "merge",
    fill = "right"
  ) %>%
  replace_na(list(Key = "Name")) %>%
  group_by(Subject,Item) %>%
  spread(Key,outputDirect) %>%
  ungroup %>%
  tidyr::extract(
    Item,
    c("Type","Valence","Id"),
    "^(Objects|Others)(Pos|Neg)(1|2)$"
  ) %>%
  mutate(
    Num = case_when(
      Type == "Objects" ~ NA_character_,
      TRUE ~ Num),
    Dir_Pos = Dir_Pos %>% as.numeric,
    Dir_Neg = Dir_Neg %>% as.numeric,
    Dir_Amb = Dir_Amb %>% as.numeric,
    Griffin = (Dir_Pos + Dir_Neg) / 2 + abs(Dir_Pos - Dir_Neg)
  ) %>%
  rename(
    "Felt" = Dir_Amb,
    "Negative" = Dir_Neg,
    "Positive" = Dir_Pos,
    "Number" = Num,
    "Relation" = Rel
  )
  
```

```{r Time - Wrangling, options}

dfTime <- RAW %>%
  gather(
    "fullTime",
    "outputTime",
    matches("^(time)")
  ) %>%
  select(Subject,Condition,Key,firstBlock,firstValence,fullTime,outputTime) %>%
  mutate(
    fullTime = gsub("time","",fullTime),
    Order = fullTime %>%
      recode(
        "Collect01" = 1,
        "Practice01" = 2 ,
        "Experiment01" = 3,
        "Collect02" = 4,
        "Practice02" = 5,
        "Experiment02" = 6,
        "Explicit" = 7,
        "Demographics" = 8,
        "Ambi" = 9,
        "Total" = 10
      )
  ) %>%
  select(Subject,Order,"Part"=fullTime,"Time"=outputTime) %>%
  arrange(Subject,Order)

```

```{r Demo - Wrangling, options}

dfDemo <- RAW %>%
  select(Subject,Condition,Key,firstBlock,firstValence,Age,Gender,Language,Handedness,Study,ambiSuggestions)

```

###########
## Output
###########

```{r Dataframe Output, exclude=TRUE}

# dfTrials %>%
#   write.csv("trialsData190603.csv")
# 
# dfTime %>%
#   write.csv("timeData190603.csv")
# 
# dfDirect %>%
#   write.csv("directData190603.csv")
# 
# dfDemo %>%
#   write.csv("demoData190603.csv")

```


############
# Analyses
############


#####################
## Full Multilevel
#####################

Possibility:
set contrasts of the primeCondition to treatment (with the letter strings as base), but
with contrasts for targetCondition to [-1, 1] for Neg and Pos respectively.

```{r Full w Random Intercepts subject & target, options}

afex::set_effects_contrasts()
fitBoth1 <- dfTrials %>%
  filter(Inclusion) %>% {
    mixed(
      logRT ~ primeCondition * targetCondition + Block + (1|targetWord) + (1|Subject),
      data = .,
      method = "S"
    )
  }

afex::set_effects_contrasts()
fitBoth2 <- dfTrials %>%
  filter(Inclusion) %>% {
    mixed(
      logRT ~ primeCondition * targetCondition + (1|Block) + (1|targetWord) + (1|Subject),
      data = .,
      method = "S"
    )
  }

afex::set_effects_contrasts()
fitObj <- dfTrials %>%
  filter(Inclusion & Block == "Objects") %>% {
    mixed(
      logRT ~ primeCondition * targetCondition + (1|targetWord) + (1|Subject),
      data = .,
      method = "S"
    )
  }

afex::set_effects_contrasts()
fitOth <- dfTrials %>%
  filter(Inclusion & Block == "Others") %>% {
    mixed(
      logRT ~ primeCondition * targetCondition + (1|targetWord) + (1|Subject),
      data = .,
      method = "S"
    )
  }


```

```{r Estimated Means, options}

emmeansFull1 <- fitBoth1 %>% emmeans(~primeCondition * targetCondition + Block)

emmeansFull2 <- fitBoth2 %>% emmeans(~primeCondition * targetCondition)

emmeansObj <- fitObj %>% emmeans(~primeCondition * targetCondition)

emmeansOth <- fitOth %>% emmeans(~primeCondition * targetCondition)

```

I should recover home changes on this; although changes to make primeCondition a factor should counteract this..

```{r Contrasts, options}

# contrFull1 <- emmeansFull1 %>%
#   contrast(method="revpairwise") %>%
#   as_tibble %>%
#   separate(contrast,c("contrastA","contrastB"),sep=" - ") %>%
#   separate(contrastA,c("primeA","targetA","blockA"),sep=",") %>%
#   separate(contrastB,c("primeB","targetB","blockB"),sep=",") %>%
#   mutate_at(
#     vars(primeA,primeB),
#     funs()
#   ) %>%
#   mutate_at(
#     
#   )
#   arrange(blockA,blockB,primeA %>% desc,primeB %>% desc,targetA)
# 
# contrFull2 <- emmeansFull2 %>%
#   contrast(method="revpairwise") %>%
#   as_tibble %>%
#   separate(contrast,c("contrastA","contrastB"),sep=" - ") %>%
#   separate(contrastA,c("primeA","targetA"),sep=",") %>%
#   separate(contrastB,c("primeB","targetB"),sep=",") %>%
#   arrange(primeA,primeB,targetA)
# 
# contrObj <- emmeansObj %>%
#   contrast(method="pairwise") %>%
#   as_tibble %>%
#   separate(contrast,c("contrastA","contrastB"),sep=" - ") %>%
#   separate(contrastA,c("primeA","targetA"),sep=",") %>%
#   separate(contrastB,c("primeB","targetB"),sep=",") %>%
#   arrange(primeA,primeB,targetA)
# 
# contrOth <- emmeansOth %>%
#   contrast(method="pairwise") %>%
#   as_tibble %>%
#   separate(contrast,c("contrastA","contrastB"),sep=" - ") %>%
#   separate(contrastA,c("primeA","targetA"),sep=",") %>%
#   separate(contrastB,c("primeB","targetB"),sep=",") %>%
#   arrange(primeA,primeB,targetA)

```

#############
### Graphs
#############

```{r Graphs, options}

plot_grid(
  emmeansOth %>%
    as_tibble %>%
    mutate_at(
      vars(emmean,asymp.LCL,asymp.UCL),
      exp
    ) %>%
    mutate(
      primeCondition = primeCondition %>%
        as.factor %>%
        factor(levels = levels(.) %>% rev)
    ) %>%
    ggplot(aes(x = primeCondition, y = emmean, fill = targetCondition, ymin = asymp.LCL, ymax = asymp.UCL)) +
    geom_col(position=position_dodge2()) +
    labs(x="Prime Conditions",y="Latency (ms)",title=paste("Comparison Estimated Mean Latency for the Others Block")) +
    guides(fill = guide_legend(title="Target\nValence")) +
    scale_fill_discrete(labels=c("Positive","Negative")) +
    geom_errorbar(position = position_dodge2(padding=.8),colour = "black",size=.5) +
    geom_label(
      data = contrOth %>%
        filter(primeA == primeB),
      aes(
        x = primeA,
        y = 10,
        label = case_when(
          p.value < .001 ~ '***',
          p.value < .01 ~ '**',
          p.value < .05 ~ '*',
          TRUE ~ p.value %>% signif(3) %>% as.character
        )
      ),
      inherit.aes = FALSE
    ) +
    theme_bw(),
  emmeansObj %>%
    as_tibble %>%
    mutate_at(
      vars(emmean,asymp.LCL,asymp.UCL),
      exp
    ) %>%
    mutate(
      primeCondition = primeCondition %>%
        as.factor %>%
        factor(levels = levels(.) %>% rev)
    ) %>%
    ggplot(aes(x = primeCondition, y = emmean, fill = targetCondition, ymin = asymp.LCL, ymax = asymp.UCL)) +
    geom_col(position=position_dodge2()) +
    labs(x="Prime Conditions",y="Latency (ms)",title=paste("Comparison Estimated Mean Latency for the Objects Block")) +
    guides(fill = guide_legend(title="Target\nValence")) +
    scale_fill_discrete(labels=c("Positive","Negative")) +
    geom_errorbar(position = position_dodge2(padding=.8),colour = "black",size=.5) +
    geom_label(
      data = contrObj %>%
        filter(primeA == primeB),
      aes(
        x = primeA,
        y = 10,
        label = case_when(
          p.value < .001 ~ '***',
          p.value < .01 ~ '**',
          p.value < .05 ~ '*',
          TRUE ~ p.value %>% signif(3) %>% as.character
        )
      ),
      inherit.aes = FALSE
    ) +
    theme_bw(),
  ncol = 1,
  align = "hv"
)

```



```{r Graphs, options}

# contrFull1 %>%
#   filter(
#     grepl("others.",primeA) & grepl("objects.",primeB) & targetA == targetB
#   ) %>% 
#   filter(
#     not(blockA == "Objects" & grepl("others.",primeA)) &
#       not(blockA == "Others" & grepl("objects.",primeA)) &
#     not(blockB == "Objects" & grepl("others.",primeB)) &
#       not(blockB == "Others" & grepl("objects.",primeB))
#     ) %>%
#   group_by(primeA,primeB) %>%
#   do(
#     plots = ggplot(data=.,aes(x=primeA,y=estimate,fill=targetA)) +
#       geom_col(position=position_dodge2()) +
#       ggtitle(paste(.$primeA,"-",.$primeB)) +
#       labs(x="",y="") +
#       scale_x_discrete(labels = NULL, breaks = NULL) +
#       scale_y_continuous(limits=c(-.08,.08)) +
#       geom_label(
#          aes(
#            y=0,
#           label=case_when(
#             p.value < .001 ~ '***',
#             p.value < .01 ~ '**',
#             p.value < .05 ~ '*',
#             TRUE ~ signif(p.value,3) %>% as.character
#           )
#       ),
#       position = position_dodge2(width=.9)
#       ) +
#       theme_bw()
#   ) %$%
#   plot_grid(
#     plotlist=plots,align="hv"
#   )

```


```{r Graphs, options}

# contrFull1 %>%
#   filter(
#     targetA == targetB &
#       blockA == blockB
#   ) %>%
#   filter(
#     grepl("(others|objects).",primeA) |
#       grepl("(others|objects).",primeB)
#   ) %>%
#   filter(
#     (blockA == "Objects" & not(grepl("others.",primeA))) |
#       (blockB == "Objects" & not(grepl("others.",primeB)))
#   ) %>%
#   group_by(blockA,primeA,primeB) %>%
#   do(
#     plots = ggplot(data=.,aes(x=primeA,y=estimate,fill=targetA)) +
#       geom_col(position=position_dodge2()) +
#       ggtitle(paste(.$primeA,"-",.$primeB)) +
#       labs(x="",y="") +
#       scale_x_discrete(labels = NULL, breaks = NULL) +
#       scale_y_continuous() +
#       geom_label(
#          aes(
#           label=case_when(
#             p.value < .001 ~ '***',
#             p.value < .01 ~ '**',
#             p.value < .05 ~ '*',
#             TRUE ~ NA_character_
#           )
#       ),
#       position = position_dodge2(width=.9)
#       ) +
#       theme_bw(legend.position="none")
#   ) %$%
#   plot_grid(
#     plotlist=plots,align="hv"
#   )


```

########################
## Partial Multilevels
########################

For all of these:

primeCondition and targetCondition are both effect coded,
with positive primes and targets as 1, and negative primes and targets as -1

```{r Nouns, options}

partNouns <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeCondition %>% grepl("noun",.)) %>%
   mixed(
      logRT ~ primeCondition * targetCondition + (1|targetWord) + (1|Subject),
      data = .,
      method = "S",
      contrasts = list(
        primeCondition = contr.sum(2),
        targetCondition = contr.sum(2)
      )
    )

summary(partNouns)

```

```{r Objects, options}

partObjects <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeCondition %>% grepl("objects",.)) %>%
   mixed(
      logRT ~ primeCondition * targetCondition + (1|targetWord) + (1|Subject),
      data = .,
      method = "S",
      contrasts = list(
        primeCondition = contr.sum(2),
        targetCondition = contr.sum(2)
      )
    )

summary(partObjects)

```

Example:

Intercept == mean(overall)

primeCondition1 == effect of Positive prime
                == - effect of Negative prime
mean(primePos) -> 6.491 + (-.009167) = 6.482 
mean(primeNeg) -> 6.491 - (-.009167) = 6.500

targetCondition1 == effect of Positive target
                 == - effect of Negative target
mean(targetPos) -> 6.491 + (-.02035) = 6.471
mean(targetNeg) -> 6.491 - (-.02035) = 6.511

primeCondition1:targetCondition1 == interaction of Positive prime and Positive targets
                                 ==

primePos:targetPos -> 6.491 + (-.009167) + (-.02035) + (-.01445) = 6.447
primeNeg:targetPos -> 6.491 - (-.009167) + (-.02035) - (-.01445) = 6.494
primePos:targetNeg -> 6.491 + (-.009167) - (-.02035) - (-.01445) = 6.517
primeNeg:targetNeg -> 6.491 - (-.009167) - (-.02035) + (-.01445) = 6.506

```{r EMM partObjects, options}

partObjEMM <- partObjects %>% emmeans(~primeCondition * targetCondition) %>% as_tibble

partObjEMM %>% group_by(primeCondition) %>% summarize(mean(emmean))
partObjEMM %>% group_by(targetCondition) %>% summarize(mean(emmean))
partObjEMM %>% select(primeCondition,targetCondition,emmean)

```


```{r Others, options}

afex::set_effects_contrasts()
partOthers <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeCondition %>% grepl("others",.)) %>%
   mixed(
      logRT ~ primeCondition * targetCondition + (1|targetWord) + (1|Subject),
      data = .,
      method = "S",
      contrasts = list(
        primeCondition = contr.sum(2),
        targetCondition = contr.sum(2)
      )
    )

summary(partOthers)

```

#########################
### Subtracting Letters
#########################

```{r Wrangling, options}

test <- dfTrials %>%
  filter(Inclusion) %>%
  

```













#####################
### Letters as Base
#####################

For all of these:

primeCondition is dummy coded, with letters as base
targetCondition is effect coded, with Positive == 1 and Negative == -1

```{r Nouns, options}

treatNouns <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeCondition %>% grepl("(noun)|(letter)",.)) %>%
   mixed(
      logRT ~ primeCondition * targetCondition + (1|targetWord) + (1|Subject),
      data = .,
      method = "S",
      check_contrasts = FALSE,
      contrasts = list(
        primeCondition = contr.SAS(3),
        targetCondition = contr.sum(2)
        )
    )

summary(treatNouns)

```

Example:

Intercept == mean(letterStr)
primeCondition1 == mean(xxxPos) - mean(letterStr)
primeCondition2 == mean(xxxNeg) - mean(letterStr)

targetCondition1 == effect of Positive target
                 == - effect of Negative target
                 == (mean(targetPos) - mean(targetNeg)) * 0.5
                 
primeCondition1:targetCondition1 == interaction of Positive target for Positive primes
                                 == - interaction of Negative target for Positive primes

6.457+.01423 -0.01984 -0.02532 == 6.43 (nounPos:Pos)
6.457+.01423 +0.01984 +0.02532 == 6.52 (nounPos:Neg)

primeCondition2:targetCondition1 == interaction of Positive target for Negative primes
                                 == - interaction of Negative target for Negative primes

6.457+0.02311 +0.01984 -0.02128 = 6.48 (nounNeg:Neg)
6.457+0.02311 -0.01984 +0.02128 = 6.48 (nounNeg:Pos)

```{r EMM Nouns, options}

treatNouns %>% emmeans(~primeCondition * targetCondition)

```


```{r Objects, options}

treatObjects <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeCondition %>% grepl("(objects)|(letter)",.)) %>%
   mixed(
      logRT ~ primeCondition * targetCondition + (1|targetWord) + (1|Subject),
      data = .,
      method = "S",
      check_contrasts = FALSE,
      contrasts = list(
        primeCondition = contr.SAS(3),
        targetCondition = contr.sum(2)
        )
    )

summary(treatObjects)

```

```{r Others, options}

treatOthers <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeCondition %>% grepl("(others)|(letter)",.)) %>%
   mixed(
      logRT ~ primeCondition * targetCondition + (1|targetWord) + (1|Subject),
      data = .,
      method = "S",
      check_contrasts = FALSE,
      contrasts = list(
        primeCondition = contr.SAS(3),
        targetCondition = contr.sum(2)
        )
    )

summary(treatOthers)

```

