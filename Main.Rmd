---
Author: Thomas Verliefde
Date: 2019/06/26
Output: html_document
Title: Main
Version: '1.1'
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# rm(list=ls())

# load("20190523.RData")

# save.image("20190523.RData")
```

```{r libraries, include=FALSE}

lapply(
  c("plyr","dplyr","tidyr","ggplot2","readr","lme4","afex","lmerTest","emmeans",
    "pbkrtest","purrr","magrittr","cowplot","parallel","svglite"),
  require,
  character.only=T
)

```

#######################
# Importing & Cleanup
#######################

###########
## Import
###########

The required datafile (Data_RelAmb02.zip) should be in the working directory.
Note that this datafile is not public on GitHub, but will be on the OSF page of this project.

```{r RAW import, include=FALSE}

temp <- tempdir()
RAW <- "dataRelAmb02.zip" %>% {
  ldply(
    .data = unzip(.,list=T) %>% # create a list of all the files/folders in the zip
      filter(grepl(".+(csv)$",.$Name)) %>% # ignore any files/folders without .csv extension
      arrange(Name %>% desc) %$% Name, # Return only the relevant .csv filenames
    .fun = function(x) {
      unzip(.,files=x,exdir=temp) %>% # Get for each of the .csv filenames the relevant file, and temporary save it
        read_csv(n_max = 1) # Import the .csv file to R
    }
  )
}
rm(temp)

```

######################
## Technical Issues
######################

Subjects 1, 82, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97 have data from during a period in which the software caused problems.
Subjects 83, 84, 85 have no data since the software issue was unresolved at the time.
Subjects 87, 90, 92, 94, 95, 96, & 97 are semi-problematic, as they do not have any direct measures recorded.
The data for latencies is complete though, and can be used for latency analyses.
Further, Subject 87 does not have fully-correct demographics.
That is why their age is indicated as 99 and their study is unknown. Their gender and language are correct though.

Subject 87: all direct measures and partial demographics
Subjects 90 92 94 95 96 97: all direct measures
Subject 161: ambiSuggestions
Subject 152: Objects_Pos1,Objects_Pos2,Others,Demo,Time
Subject 149: ambiSuggestions
Subject 145: Others_Pos2,Demo,Time
Subject 102: ambiSuggestions

Subjects 152 and 145 are missing all demographics, and many direct measures.
Subject 87 is missing partial demographics.

The ambiSuggestions variable missing is no issue for this exp.

Subject 107 apparently performed the experiment twice. Only the results from the first experiment will be used.
This is ensured during the import of the data by specifying "n_max = 1".

```{r NA in RAW, eval=FALSE, exclude=TRUE, include=FALSE}

RAW %>%
  select(
    grep("^(Objects).+(Num)$",names(.),invert=TRUE)
  ) %>%
  filter_all(any_vars(is.na(.))) %>%
  group_by(Subject,Condition,Key,firstBlock,firstValence) %>%
  select_if(function(x) any(is.na(x))) %>%
  ungroup %>% View(.)

```

```{r RAW - Wrangling, include=FALSE}

RAW %<>%
  mutate_at(
    vars(Age,Handedness,Study,ambiSuggestions),
    funs(
      case_when(
        Subject == 87 ~ NA_character_,
        TRUE ~ .
      )
    )
  ) %>%
  as_tibble %>%
  select(
    -matches("^(practice|experiment)(Primes|Trials)(Objects|Others)$"),
    -hostName
  ) %>%
  mutate(
    Subject = Subject %>% as.numeric %>% factor(levels = unique(.) %>% sort),
    Age = Age %>% as.numeric
  )

```

#############################
## Provided Others & Objects 
#############################

```{r Others & Objects, eval=FALSE, include=FALSE}

RAW %>%
  select(Subject,starts_with("collect"),ends_with("Rel")) %>%
  gather(collect,Name,starts_with("collect")) %>%
  gather(relation,Comment,ends_with("Rel")) %>%
  mutate(
    collect = collect %>%
      gsub("(collect)(Objects|Others)","\\2_",.),
    relation = relation %>%
      gsub("(_Rel)$","",.)
  ) %>%
  filter(collect == relation) %>%
  select(-relation) %>%
  separate(collect,c("Source","Valence")) %>%
  arrange(Subject,Source,Valence) %>% View(.)

```

###############
## Wrangling
###############

```{r Trials - Wrangling, options}

dfTrials <- RAW %>%
  gather(
    "fullTrials",
    "outputTrials",
    matches("^(practice|experiment)_(Objects|Others)(\\d)+_(answer|time|prime|target)(Cat)?")
  ) %>%
  select(Subject,Condition,Key,firstBlock,firstValence,fullTrials,outputTrials) %>%
  tidyr::extract(
    fullTrials,
    c("Segment","Block","Trial","components"),
    "^(practice|experiment)_(Objects|Others)(\\d+)_(\\D+)$"
  ) %>%
  group_by(Subject,Trial,Segment,Block) %>%
  spread(
    components,
    outputTrials
  ) %>%
  ungroup %>%
  rename(
    Response = answer,
    primeWord = prime,
    primeCondition = primeCat,
    targetWord = target,
    targetCondition = targetCat,
    RT = time
  ) %>%
  mutate(
    Trial = Trial %>% as.numeric %>% factor(levels = unique(.) %>% sort),
    primeCondition = primeCondition %>%
      recode(
        "0" = "nounPos",
        "1" = "nounNeg",
        "2" = paste0(tolower(Block),"Pos"),
        "3" = paste0(tolower(Block),"Neg"),
        "4" = "letterStr"
      ) %>% factor(levels = c("othersPos","othersNeg","objectsPos","objectsNeg","nounPos","nounNeg","letterStr")),
    # The following two variables could be created with an tidyr::extract(primeCondition,c("primeValence","primeSource"),"^(.+)([A-Z]{1}.+)$")
    primeValence = primeCondition %>%
      gsub("^(.+)([A-Z]{1}.+)$","\\2",.) %>% factor(levels = c("Pos","Neg","Str")),
    primeSource = primeCondition %>%
      gsub("^(.+)([A-Z]{1}.+)$","\\1",.) %>% factor(levels = c("others","objects","noun","letter")),
    targetCondition = targetCondition %>%
      recode_factor(
        "0" = "Pos",
        "1" = "Neg"
      ),
    Congruency = case_when(
      primeValence %>% as.character == targetCondition %>% as.character ~ "Congruent",
      primeValence == "Str" ~ "Base",
      TRUE ~ "Incongruent"
    ),
    RT = RT %>% as.numeric,
    logRT = RT %>% as.numeric %>% log,
    Correct = case_when(
      Response == "A" & targetCondition == "Pos" & Key == "Apos" ~ TRUE,
      Response == "A" & targetCondition == "Neg" & Key == "Aneg" ~ TRUE,
      Response == "L" & targetCondition == "Neg" & Key == "Apos" ~ TRUE,
      Response == "L" & targetCondition == "Pos" & Key == "Aneg" ~ TRUE,
      TRUE ~ FALSE
    ),
    orderBlock = case_when(
      Block == firstBlock ~ "1",
      TRUE ~ "2"
    ) %>% factor(levels = c("1","2"))
  ) %>%
  group_by(Subject,Segment) %>%
  mutate(
    Accuracy = mean(Correct),
    latencyInclusion = (RT >= 300 & RT <= 3000),
    trialInclusion = latencyInclusion & Correct,
    accInclusion = (1 - mean(trialInclusion)) < 0.83,
    nameExclusion = Subject %in% c(86,117,125,129,135,141,142,145,156),
    # Subject exclusions 86,105,117,125,129,135,141,142,145,156 are due to not providing decent object or other names.
    # Note that there is quite a gray zone of acceptance, which is discussable.
    subjExclusion = not(accInclusion) | nameExclusion,
    Inclusion = trialInclusion & not(subjExclusion) & Segment == "experiment"
  ) %>%
  ungroup %>%
  arrange(Subject,Block,desc(Segment),Trial)

```

For each SPP, facilitation-inhibition of positive targets was computed by subtracting
 the average RT for valenced prime / positive trials from the average RT for letter string / positive trials (Fazio et al., 1986).
Similarly, facilitation-inhibition of negative targets was computed by subtracting
 the average RT for valenced prime / negative trials from the average RT for the letter string / negative trials.

```{r Delta - over Subject & targetWord, options}

dfDelta <- dfTrials %>%
  filter(Inclusion) %>%
  group_by(Subject,Key,firstBlock,firstValence,Block,targetWord,targetCondition,primeCondition) %>%
  summarize(
    avgRT = mean(RT)
  ) %>%
  spread(primeCondition,avgRT) %>%
  mutate_at(
    vars(nounNeg,nounPos,objectsNeg,objectsPos,othersNeg,othersPos,letterStr),
    funs(subtract(letterStr,.))
  ) %>%
  gather(primeCondition,deltaRT,nounNeg,nounPos,objectsNeg,objectsPos,othersNeg,othersPos,letterStr) %>%
  na.omit %>%
  ungroup

```

```{r Direct - Wrangling, options}

dfDirect <- RAW %>%
  gather(
    "fullDirect",
    "outputDirect",
    matches("^(Objects|Others)_(Neg|Pos)(1|2)_(Dir|Num|Rel)_?(Amb|Neg|Pos)?"),
    matches("^(collect)(Objects|Others)(Neg|Pos)(1|2)$")
  ) %>% 
  select(Subject,Condition,Key,firstBlock,firstValence,fullDirect,outputDirect) %>%
  mutate(
    fullDirect = sub("(_)|(collect)","",fullDirect)
  ) %>%
  separate(
    fullDirect,
    c("Item","Measure"),
    "_",
    extra = "merge",
    fill = "right"
  ) %>%
  replace_na(list(Measure = "Name")) %>%
  group_by(Subject,Item) %>%
  spread(Measure,outputDirect) %>%
  ungroup %>%
  tidyr::extract(
    Item,
    c("Type","Valence","Id"),
    "^(Objects|Others)(Pos|Neg)(1|2)$"
  ) %>%
  mutate(
    Num = case_when(
      Type == "Objects" ~ NA_character_,
      TRUE ~ Num),
    Dir_Pos = Dir_Pos %>% as.numeric,
    Dir_Neg = Dir_Neg %>% as.numeric,
    Dir_Amb = Dir_Amb %>% as.numeric,
    Griffin = (Dir_Pos + Dir_Neg) / 2 - abs(Dir_Pos - Dir_Neg)
  ) %>%
  rename(
    "Felt" = Dir_Amb,
    "Negative" = Dir_Neg,
    "Positive" = Dir_Pos,
    "Number" = Num,
    "Relation" = Rel
  ) %>%
  left_join(
    dfTrials %>% distinct(Subject,nameExclusion,subjExclusion),
    by=c("Subject")
  )
  
```

```{r Time - Wrangling, options}

dfTime <- RAW %>%
  gather(
    "fullTime",
    "outputTime",
    matches("^(time)")
  ) %>%
  select(Subject,Condition,Key,firstBlock,firstValence,fullTime,outputTime) %>%
  mutate(
    fullTime = gsub("time","",fullTime),
    Order = fullTime %>%
      recode(
        "Collect01" = 1,
        "Practice01" = 2 ,
        "Experiment01" = 3,
        "Collect02" = 4,
        "Practice02" = 5,
        "Experiment02" = 6,
        "Explicit" = 7,
        "Demographics" = 8,
        "Ambi" = 9,
        "Total" = 10
      )
  ) %>%
  select(Subject,Order,"Part"=fullTime,"Time"=outputTime) %>%
  arrange(Subject,Order) %>%
  left_join(
    dfTrials %>% distinct(Subject,nameExclusion,subjExclusion),
    by=c("Subject")
  )

```

```{r Demo - Wrangling, options}

dfDemo <- RAW %>%
  select(Subject,Condition,Key,firstBlock,firstValence,Age,Gender,Language,Handedness,Study,ambiSuggestions) %>%
  left_join(
    dfTrials %>% distinct(Subject,nameExclusion,subjExclusion),
    by=c("Subject")
  )

```

###########
## Output
###########

```{r Dataframe Output, exclude=TRUE, eval=FALSE, include=FALSE}

# dfTrials %>%
#   write.csv("trialsData190625.csv")
# 
# dfTime %>%
#   write.csv("timeData190625.csv")
# 
# dfDirect %>%
#   write.csv("directData190625.csv")
# 
# dfDemo %>%
#   write.csv("demoData190625.csv")

```


##########
# Demog
##########

```{r Balance, options}

dfDemo %>%
  count(Condition,Key,firstBlock,firstValence)

dfDemo %>%
  count(subjExclusion)

dfDemo %>%
  filter(subjExclusion %>% not) %>%
  count(Condition,Key,firstBlock,firstValence)

dfDemo %>%
  filter(subjExclusion %>% not) %>%
  count(Key)

dfDemo %>%
  filter(subjExclusion %>% not) %>%
  count(firstBlock)

dfDemo %>%
  filter(subjExclusion %>% not) %>%
  count(firstValence)

dfDemo %$%
   `%in%`(c(81:160),Subject) %>%
  not %>%
  magrittr::extract(c(81:160),.)

dfDemo %$%
  '%in%'(Subject,c(81:160)) %>%
  not %>%
  magrittr::extract(dfDemo$Subject,.) %>%
  as.character

```

```{r Demos, options}

dfDemo %>%
  filter(subjExclusion %>% not) %>%
  summarize_at(
    "Age",
    funs(mean,sd,min,max,median),
    na.rm = TRUE
  )

```

```{r Acc, options}

dfTrials %>%
  filter(Inclusion) %>%
  distinct(Subject,Accuracy) %>%
  arrange(Accuracy)

dfTrials %>%
  filter(Inclusion) %>%
  distinct(Subject,Accuracy) %>%
  summarize_at(
    "Accuracy",
    funs(mean,sd,min,max,median),
    na.rm=TRUE
  )

dfTrials %>%
  filter(Inclusion) %>%
  distinct(Subject,Accuracy) %>%
  ggplot(aes(y = Accuracy)) +
  geom_boxplot()

```


```{r Excluded Trials, options}

dfTrials %>%
  distinct(Subject,nameExclusion) %>%
  count(nameExclusion) %>%
  filter(nameExclusion) %$%
  paste0("We excluded ",n," participants because of not following instructions.")

dfTrials %>%
  distinct(Subject,accInclusion) %>%
  count(accInclusion) %>%
  filter(accInclusion) %$%
  paste0("We excluded ",n-85," participants because of major latency issues.")

dfTrials %$%
  mean(latencyInclusion) %>%
  subtract(1,.) %>%
  round(5) %>%
  paste0(.,"% of total trials were below 300ms or above 3000ms.")

dfTrials %>%
  filter(subjExclusion) %$%
  mean(latencyInclusion) %>%
  subtract(1,.) %>%
  round(5) %>%
  paste0("For the included participants, ",.,"% of trials were below 300ms or above 3000ms and as such excluded.")

dfTrials %$%
  mean(Correct) %>%
  subtract(1,.) %>%
  round(5) %>%
  paste0(.,"% of total trials were incorrect.")

dfTrials %>%
  filter(subjExclusion) %$%
  mean(Correct) %>%
  subtract(1,.) %>%
  round(5) %>%
  paste0("For the included participants, ",.,"% of trials were incorrect and as such excluded.")

dfTrials %$%
  mean(Inclusion) %>%
  subtract(1,.) %>%
  round(5) %>%
  paste0("Overall, ",.,"% of trials had to be excluded.")

```

############
# Analyses
############

#####################
## Multilevel Model
#####################

################
### Congruency
################

```{r Model, options}

congruencyModel <- function(data,primes,block = c("Others","Objects")){
  fit <- data %>%
    filter(Inclusion) %>%
    filter(primeSource == primes) %>%
    filter(firstBlock %in% block) %>%
  mixed(
    logRT ~ primeCondition * targetCondition + (1|Subject) + (1|targetWord),
    data = .,
    method = "S",
    check_contrasts = TRUE,
      contrasts = list(primeCondition = contr.sum(2), targetCondition = contr.sum(2))
    )
  return(fit)
}

```


```{r Congruency Models Others, options}

afex::set_effects_contrasts()

congruencyOthers <- dfTrials %>%
  congruencyModel("others")
congruencyOthers

congruencyOthersBetween <- dfTrials %>%
  congruencyModel("others","Others")
congruencyOthersBetween

congruencyOthersBetween2nd <- dfTrials %>%
  congruencyModel("others","Objects")
congruencyOthersBetween2nd

```

```{r Congruency Objects, options}

afex::set_effects_contrasts()

congruencyObjects <- dfTrials %>%
  congruencyModel("objects")
congruencyObjects

congruencyObjectsBetween <- dfTrials %>%
  congruencyModel("objects","Objects")
congruencyObjectsBetween

congruencyObjectsBetween2nd <- dfTrials %>%
  congruencyModel("objects","Others")
congruencyObjectsBetween2nd

```

```{r Congruency Nouns, options}

afex::set_effects_contrasts()

congruencyNouns <- dfTrials %>%
  congruencyModel("noun")
congruencyNouns

congruencyNounsBetweenObjects <- dfTrials %>%
  congruencyModel("noun","Others")
congruencyNounsBetweenObjects

congruencyNounsBetweenOthers <- dfTrials %>%
  congruencyModel("noun","Objects")
congruencyNounsBetweenOthers

```

When testing for the congruency-effect between participants, there is no congruency effect observed for objects in the first block, but there is for the second block.


########################
#### Control Variables
########################

```{r Control Variables, options}

congruencyOthersControl <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeSource == "others") %>%
  mixed(
    logRT ~ (primeCondition * targetCondition) * (Key + firstBlock + firstValence) + (1|Subject) + (1|targetWord),
    data = .,
    method = "S",
    check_contrasts = TRUE,
    contrasts = list(primeCondition = contr.sum(2), targetCondition = contr.sum(2))
  )
congruencyOthersControl

congruencyObjectsControl <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeSource == "objects") %>%
  mixed(
    logRT ~ (primeCondition * targetCondition) * (Key + firstBlock + firstValence) + (1|Subject) + (1|targetWord),
    data = .,
    method = "S",
    check_contrasts = TRUE,
    contrasts = list(primeCondition = contr.sum(2), targetCondition = contr.sum(2))
  )
congruencyObjectsControl

congruencyNounsControl <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeSource == "noun") %>%
  mixed(
    logRT ~ (primeCondition * targetCondition * Block) * (Key + firstBlock + firstValence) +  (1|Subject) + (1|targetWord),
    data = .,
    method = "S",
    check_contrasts = TRUE,
    contrasts = list(primeCondition = contr.sum(2), targetCondition = contr.sum(2))
  )
congruencyNounsControl

```

```{r Specific Contrasts Others/Objects, options}

congruencyOthersControl %>%
  emmeans(~primeCondition:targetCondition:firstBlock) %>%
  contrast(by=c("primeCondition","targetCondition"))

congruencyObjectsControl %>%
  emmeans(~primeCondition:targetCondition:firstBlock) %>%
  contrast(by=c("primeCondition","targetCondition"))

```

For Others (with lackluster alpha inflation):
  primeCondition = othersNeg, targetCondition = Neg:
    contrast       estimate     SE  df t.ratio p.value
    Objects effect  -0.0330 0.0186 110 -1.769  0.0797 
    Others effect    0.0330 0.0186 110  1.769  0.0797 

For Objects (with lackluster alpha inflation):
  primeCondition = objectsNeg, targetCondition = Neg:
    contrast       estimate     SE  df t.ratio p.value
    Objects effect  0.04044 0.0200 105  2.026  0.0453 
    Others effect  -0.04044 0.0200 105 -2.026  0.0453 

```{r Specific Contrasts Nouns, options}

congruencyNounsControl %>%
  emmeans(~Block)

congruencyNounsControl %>%
  emmeans(~Block:firstBlock) %>%
  contrast

```

For Nouns:

 Block   emmean     SE  df asymp.LCL asymp.UCL
 Objects   6.45 0.0172 Inf      6.42      6.49
 Others    6.49 0.0172 Inf      6.46      6.53
 
 Block - firstBlock      estimate     SE  df z.ratio p.value
 Objects Objects effect  -0.00947 0.0163 Inf -0.582  0.6546 
 Others  Objects effect  -0.00727 0.0162 Inf -0.447  0.6546 
 Objects Others  effect  -0.03128 0.0163 Inf -1.923  0.1089 
 Others  Others  effect   0.04802 0.0163 Inf  2.954  0.0125 

##################
### Others-Nouns
##################

```{r Nouns within Block, options}

afex::set_effects_contrasts()

comparisonOthersNouns <- dfTrials %>%
  filter(Inclusion) %>%
  filter(Block == "Others" & primeSource %in% c("others","noun")) %>%
  mixed(
    logRT ~ primeValence * targetCondition * primeSource + (1|targetWord) + (1|Subject),
    data = .,
    method = "S"
  )
comparisonOthersNouns

```

                                    Effect         df      F p.value
1                             primeValence 1, 4104.91  12.59   .0004 ***
2                          targetCondition 1,   13.97  8.15    .01   *
3                              primeSource 1, 4104.10  0.09    .77
4             primeValence:targetCondition 1, 4110.07  92.09  <.0001 ***
5                 primeValence:primeSource 1, 4104.53  9.84    .002  ** 
6              targetCondition:primeSource 1, 4103.92  0.00   >.99
7 primeValence:targetCondition:primeSource 1, 4104.59  2.05    .15

The only effect of primeSource seems to be on primeValence

```{r PrimeSource Contrasts, options}

comparisonOthersNouns %>%
  emmeans(~primeValence:primeSource) %>% contrast

```

 contrast          estimate      SE  df z.ratio p.value
 Neg,noun effect    0.00042 0.00633 Inf  0.066  0.9470 
 Pos,noun effect   -0.00257 0.00626 Inf -0.410  0.9088 
 Neg,others effect  0.02531 0.00627 Inf  4.033  0.0002 
 Pos,others effect -0.02316 0.00625 Inf -3.705  0.0004 

```{r Specific Contrasts, options}

emmeansOthersNouns <- comparisonOthersNouns %>%
  emmeans(~primeValence*targetCondition*primeSource)

contrastsOthersNouns <- emmeansOthersNouns %>%
  contrast(method="revpairwise") %>%
  as_tibble %>%
  separate(
    contrast,
    c("primeValenceA","targetValenceA","primeSourceA","primeValenceB","targetValenceB","primeSourceB")
  )

specificContrastsOthersNouns <- contrastsOthersNouns %>%
  filter(
    targetValenceA == targetValenceB,
    primeSourceA != primeSourceB,
    primeValenceA != targetValenceA
  ) %>%
  select(-targetValenceB)
specificContrastsOthersNouns

```

Expected results, with no difference between others and nouns for the incongruent conditions,
 and significant difference between incongruent others and congruent nouns with the same target valence, showing slower incongruent trials.


#####################
### Others-Objects
#####################

```{r Objects between Block, options}

afex::set_effects_contrasts()

comparisonOthersObjectsBlock <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeSource %in% c("others","objects")) %>%
  mixed(
    logRT ~ primeValence * targetCondition * primeSource * firstBlock + (1|targetWord) + (1|Subject),
    data = .,
    method = "S"
  )
comparisonOthersObjectsBlock

```

```{r Interaction primeSource:firstBlock, options}

comparisonOthersObjectsBlock %>%
  emmeans(~primeSource:firstBlock)

comparisonOthersObjectsBlock %>%
  emmeans(~primeSource:firstBlock) %>%
  contrast(method="pairwise")

```

The interaction between primeSource and firstBlock seems to be along the lines where the first block resulted in higher latencies in comparison to the second block.

```{r Order of Block, options}

comparisonOthersObjectsOrderBlock <- dfTrials %>%
 filter(Inclusion) %>%
  filter(primeSource %in% c("others","objects")) %>%
  mixed(
    logRT ~ primeValence * targetCondition * primeSource * orderBlock + (1|targetWord) + (1|Subject),
    data= .,
    method="S"
  )

```

```{r contrasts order of block, options}

comparisonOthersObjectsOrderBlock %>% {
  emmeans(.,~primeValence) %>% print
  emmeans(.,~targetCondition) %>% print
  emmeans(.,~primeSource) %>% print
  emmeans(.,~orderBlock) %>% print
  emmeans(.,~primeValence:targetCondition) %>% print
  emmeans(.,~primeValence:targetCondition:primeSource) %>% print
  emmeans(.,~primeValence:targetCondition:orderBlock) %>% print
}

```



I should do some model comparison to find a good fitting model?

```{r Objects between Block Random, options}


afex::set_effects_contrasts()

comparisonOthersObjectsBlockRandom <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeSource %in% c("others","objects")) %>%
  mixed(
    logRT ~ primeValence * targetCondition * primeSource * orderBlock + (1|targetWord) + (1|Subject),
    data = .,
    method = "S"
  )
comparisonOthersObjectsBlockRandom %>% summary

```

Note that the addition of firstBlock as a random intercept with slope on primeSource fully removes the main effect primeSource seemed to have.
As an additional test, we opted to perform the above analyses between subject, instead of between block.

```{r Objects between Subject - 1st Block, options}

afex::set_effects_contrasts()

comparisonOthersObjectsSubject1 <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeSource %in% c("others","objects")) %>%
  filter(orderBlock == "1") %>%
  mixed(
    logRT ~ primeValence * targetCondition * primeSource + (1|targetWord) + (1|Subject),
    data = .,
    method = "S"
  )
comparisonOthersObjectsSubject1

```

                                    Effect         df      F p.value
1                             primeValence 1, 1997.04  10.32    .001  **
2                          targetCondition 1,   13.72   8.82    .01   *
3                              primeSource 1,   67.95   0.35    .56
4             primeValence:targetCondition 1, 2000.87  12.25    .0005 ***
5                 primeValence:primeSource 1, 1997.72   2.12    .15
6              targetCondition:primeSource 1, 1995.36   0.63    .43
7 primeValence:targetCondition:primeSource 1, 2001.10   5.07    .02   *

```{r Objects between Subject - 2nd Block, options}

afex::set_effects_contrasts()

comparisonOthersObjectsSubject2 <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeSource %in% c("others","objects")) %>%
  filter(orderBlock == "2") %>%
  mixed(
    logRT ~ primeValence * targetCondition * primeSource + (1|targetWord) + (1|Subject),
    data = .,
    method = "S"
  )
comparisonOthersObjectsSubject2

```




```{r Contrasts others objects, options}

emmeansOthersObjectsBlock <- comparisonOthersObjectsBlockRandom %>%
  emmeans(~primeValence*targetCondition*primeSource)

emmeansOthersObjectsSubject <- comparisonOthersObjectsSubject1 %>%
  emmeans(~primeValence*targetCondition*primeSource)

```


###########
#### Graph
###########

```{r Graphs others objects, options}

plot_grid(
  emmeansOthersObjectsBlock %>%
    as_tibble %>%
    mutate(primeSource = factor(primeSource,levels=c("others","objects"))) %>%
    ggplot(aes(x=factor(primeValence,levels=c("Pos","Neg")),y=exp(emmean),group=primeSource,fill=targetCondition)) +
    geom_col(position=position_dodge2()) +
    facet_wrap('primeSource',scales = "fixed",strip.position = "bottom") +
    labs(x = "Prime Valence", y = "Reaction Time", fill = "Target\nValence", title = "Random Slope Model") +
    scale_y_continuous(limits=c(0,750)) +
    theme(
      panel.spacing = unit(0,"lines"),
      strip.background = element_blank(),
      strip.placement = "outside",
      strip.text = element_text(size=13.5,margin = margin(.15,0,.15,0,unit="cm"))
    ) +
    theme(
      legend.position="none",
      panel.grid.major.y = element_line()
    ),
  NULL,
  emmeansOthersObjectsSubject %>%
    as_tibble %>%
    mutate(primeSource = factor(primeSource,levels=c("others","objects"))) %>%
    ggplot(aes(x=factor(primeValence,levels=c("Pos","Neg")),y=exp(emmean),group=primeSource,fill=targetCondition)) +
    geom_col(position=position_dodge2()) +
    facet_wrap('primeSource',scales = "fixed",strip.position = "bottom") +
    labs(x = "Prime Valence", y = "Reaction Time", fill = "Target\nValence", title = "Between Subjects Model") +
    scale_y_continuous(limits=c(0,750)) +
    theme(
      panel.spacing = unit(0,"lines"),
      strip.background = element_blank(),
      strip.placement = "outside",
      strip.text = element_text(size=13.5,margin = margin(.15,0,.15,0,unit="cm"))
    ) +
    theme(
      axis.title.y = element_blank(),
      axis.ticks.y = element_blank(),
      axis.text.y = element_blank(),
      axis.line.y=element_blank(),
      panel.grid.major.y = element_line()
    ),
  nrow = 1,
  rel_widths = c(1,-.06,1.1)
)

```

There seems to be some differences between the models, at the very least regarding overall latency.


################
#### Contrasts
################

```{r Comparing Prime Valence, options}

contrastsOthersObjects <- emmeansOthersObjectsSubject %>%
  contrast(method="revpairwise") %>%
  as_tibble %>%
  separate(
    contrast,
    c("primeValenceA","targetValenceA","primeSourceA","primeValenceB","targetValenceB","primeSourceB")
  )

```

```{r Specific Contrast Test Others Objects, options}

contrastsOthersObjects<- emmeansOthersObjectsSubject %>%
  contrast(method="revpairwise") %>%
  as_tibble %>%
  separate(
    contrast,
    c("primeValenceA","targetValenceA","primeSourceA","primeValenceB","targetValenceB","primeSourceB")
  )

specificContrastsOthersObjects <- contrastsOthersObjects %>%
  filter(
    targetValenceA == targetValenceB,
    primeSourceA != primeSourceB,
    primeValenceA != targetValenceA
  ) %>%
  select(-targetValenceB)
specificContrastsOthersObjects

```

#####################
### Others - Letter
#####################

```{r simple model others, options}

comparisonOthersLetter <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeSource %in% c("others","letter")) %>%
  filter(Block == "Others") %>%
  # mutate(
  #   primeValence = primeValence %>%
  #     factor(levels = c("Str","Pos","Neg")),
  #   targetCondition = targetCondition %>%
  #     factor(levels = c("Pos","Neg"))
  # ) %>%
  mixed(
    logRT ~ primeValence * targetCondition + (1|targetWord) + (1|Subject),
    data = .,
    method = "S",
    check_contrasts = TRUE,
    contrasts = list(
      "primeValence" = contr.SAS(3),
      "targetCondition" = contr.sum(2)
    )
  )
comparisonOthersLetter

```

```{r contrasts others, options}

emmeansOthersLetter <- comparisonOthersLetter %>%
  emmeans(~primeValence*targetCondition)
emmeansOthersLetter

contrastsOthersLetter <- emmeansOthersLetter %>%
  contrast(method="pairwise") %>% #method="trt.vs.ctrlk",by="targetCondition"
  as_tibble %>%
  separate(
    contrast,
    c("primeValenceA","targetValenceA","primeValenceB","targetValenceB")
  )
contrastsOthersLetter

```


```{r graph others, options}

graphOthersLetter <- emmeansOthersLetter %>%
  as_tibble %>%
  mutate(
    RT = emmean %>% exp
  ) %>% {
    left_join(
      filter(.,primeValence != "Str"),
      select(.,primeValence,RT,targetCondition) %>%
        spread(primeValence,RT) %>%
        gather(primeValence,RT,Pos,Neg) %>%
        mutate(
          deltaRT = subtract(RT,Str)
        ) %>%
        select(-RT,-Str),
      by=c("primeValence","targetCondition")
    )
  } %>%
  select(primeValence,targetCondition,RT,deltaRT,everything()) %>%
  ggplot(aes(x=factor(primeValence,levels = c("Pos","Neg")),y=deltaRT,fill=factor(targetCondition,levels=c("Pos","Neg")))) +
  geom_col(position=position_dodge2()) +
  labs(x=NULL,y=expression(Delta * " Reaction Time (ms)"),title="Others - Strings") +
  guides(fill=guide_legend(title="Target\nValence")) +
  scale_y_continuous(breaks = seq(-20,100,20),limits = c(-30,60)) +
  geom_label(
    data = contrastsOthersLetter %>%
      filter(
        targetValenceA == targetValenceB,
        primeValenceB == "Str"
      ) %>%
      mutate(
        p = case_when(
          p.value < .001 ~ '***',
          p.value < .01 ~ '**',
          p.value < .05 ~ '*',
          TRUE ~ p.value %>% signif(3) %>% as.character %>% gsub("^0.",".",.)
        )
      ),
    aes(x=factor(primeValenceA,levels = c("Pos","Neg")),y=0,label=p,group=factor(targetValenceA,levels=c("Pos","Neg"))),
    position=position_dodge2(width=.9),
    inherit.aes = FALSE
  )

```


######################
### Objects - Letter
######################

```{r simple model objects, options}

comparisonObjectsLetter <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeSource %in% c("objects","letter")) %>%
  filter(Block == "Objects") %>%
  # mutate(
  #   primeValence = primeValence %>%
  #     factor(levels = c("Str","Pos","Neg")),
  #   targetCondition = targetCondition %>%
  #     factor(levels = c("Pos","Neg"))
  # ) %>%
  mixed(
    logRT ~ primeValence * targetCondition + (1|targetWord) + (1|Subject),
    data = .,
    method = "S",
    check_contrasts = FALSE,
    contrasts = list(
      "primeValence" = contr.SAS(3),
      "targetCondition" = contr.sum(2)
    )
  )
comparisonObjectsLetter

```

```{r contrasts objects, options}

emmeansObjectsLetter <- comparisonObjectsLetter %>%
  emmeans(~primeValence*targetCondition)
emmeansObjectsLetter

contrastsObjectsLetter <- emmeansObjectsLetter %>%
  contrast(method="pairwise") %>%
  as_tibble %>%
  separate(
    contrast,
    c("primeValenceA","targetValenceA","primeValenceB","targetValenceB")
  )
contrastsObjectsLetter

```


```{r graph objects, options}

graphObjectsLetter <- emmeansObjectsLetter %>%
  as_tibble %>%
  mutate(
    RT = emmean %>% exp
  ) %>% {
    left_join(
      filter(.,primeValence != "Str"),
      select(.,primeValence,RT,targetCondition) %>%
        spread(primeValence,RT) %>%
        gather(primeValence,RT,Pos,Neg) %>%
        mutate(
          deltaRT = subtract(RT,Str)
        ) %>%
        select(-RT,-Str),
      by=c("primeValence","targetCondition")
    )
  } %>%
  select(primeValence,targetCondition,RT,deltaRT,everything()) %>%
  ggplot(aes(x=factor(primeValence,levels = c("Pos","Neg")),y=deltaRT,fill=factor(targetCondition,levels=c("Pos","Neg")))) +
  geom_col(position=position_dodge2()) +
  labs(x=NULL,y=expression(Delta * " Reaction Time (ms)"),title="Objects - Strings") +
  guides(fill=guide_legend(title="Target\nValence")) +
  scale_y_continuous(breaks = seq(-20,100,20),limits = c(-30,60)) +
  geom_label(
    data = contrastsObjectsLetter %>%
      filter(
        targetValenceA == targetValenceB,
        primeValenceB == "Str"
      ) %>%
      mutate(
        p = case_when(
          p.value < .001 ~ '***',
          p.value < .01 ~ '**',
          p.value < .05 ~ '*',
          TRUE ~ p.value %>% signif(3) %>% as.character %>% gsub("^0.",".",.)
        )
      ),
    aes(x=factor(primeValenceA,levels = c("Pos","Neg")),y=0,label=p,group=factor(targetValenceA,levels=c("Pos","Neg"))),
    position=position_dodge2(width=.9),
    inherit.aes = FALSE
  )

```




######################
### Nouns - Letter
######################

```{r simple model nouns, options}

comparisonNounsLetter <- dfTrials %>%
  filter(Inclusion) %>%
  filter(primeSource %in% c("noun","letter")) %>%
  # filter(Block == "Objects") %>%
  # mutate(
  #   primeValence = primeValence %>%
  #     factor(levels = c("Str","Pos","Neg")),
  #   targetCondition = targetCondition %>%
  #     factor(levels = c("Pos","Neg"))
  # ) %>%
  mixed(
    logRT ~ primeValence * targetCondition + (1|targetWord) + (1|Subject),
    data = .,
    method = "S",
    check_contrasts = FALSE,
    contrasts = list(
      "primeValence" = contr.SAS(3),
      "targetCondition" = contr.sum(2)
    )
  )
comparisonNounsLetter

```

```{r contrasts noun, options}

emmeansNounsLetter <- comparisonNounsLetter %>%
  emmeans(~primeValence*targetCondition)
emmeansNounsLetter

contrastsNounsLetter <- emmeansNounsLetter %>%
  contrast(method="pairwise") %>%
  as_tibble %>%
  separate(
    contrast,
    c("primeValenceA","targetValenceA","primeValenceB","targetValenceB")
  )
contrastsNounsLetter

```


```{r graph noun, options}

graphNounsLetter <- emmeansNounsLetter %>%
  as_tibble %>%
  mutate(
    RT = emmean %>% exp
  ) %>% {
    left_join(
      filter(.,primeValence != "Str"),
      select(.,primeValence,RT,targetCondition) %>%
        spread(primeValence,RT) %>%
        gather(primeValence,RT,Pos,Neg) %>%
        mutate(
          deltaRT = subtract(RT,Str)
        ) %>%
        select(-RT,-Str),
      by=c("primeValence","targetCondition")
    )
  } %>%
  select(primeValence,targetCondition,RT,deltaRT,everything()) %>%
  ggplot(aes(x=factor(primeValence,levels = c("Pos","Neg")),y=deltaRT,fill=factor(targetCondition,levels=c("Pos","Neg")))) +
  geom_col(position=position_dodge2()) +
  labs(x=NULL,y=expression(Delta * " Reaction Time (ms)"),title="Nouns - Strings") +
  guides(fill=guide_legend(title="Target\nValence")) +
  scale_y_continuous(breaks = seq(-20,100,20),limits = c(-30,60)) +
  geom_label(
    data = contrastsNounsLetter %>%
      filter(
        targetValenceA == targetValenceB,
        primeValenceB == "Str"
      ) %>%
      mutate(
        p = case_when(
          p.value < .001 ~ '***',
          p.value < .01 ~ '**',
          p.value < .05 ~ '*',
          TRUE ~ p.value %>% signif(3) %>% as.character %>% gsub("^0.",".",.)
        )
      ),
    aes(x=factor(primeValenceA,levels = c("Pos","Neg")),y=0,label=p,group=factor(targetValenceA,levels=c("Pos","Neg"))),
    position=position_dodge2(width=.9),
    inherit.aes = FALSE
  )

```

#####################################
### Combined Plot Comparisons Letter
#####################################


```{r Combined Plot Object - Other, options}

plot_grid(
  graphObjectsLetter +
  scale_y_reverse(breaks = seq(60,-100,-20),limits = c(60,-30)) +
    theme(
      legend.position = "none",
      panel.grid.major.y = element_line()
    ),
  NULL,
  graphOthersLetter +
  scale_y_reverse(breaks = seq(60,-100,-20),limits = c(60,-30)) +
    theme(
      legend.position="none",
      axis.title.y = element_blank(),
      axis.ticks.y = element_blank(),
      axis.text.y = element_blank(),
      axis.line.y=element_blank(),
      panel.grid.major.y = element_line()
    ),
  NULL,
  graphNounsLetter +
    scale_y_reverse(breaks = seq(60,-100,-20),limits = c(60,-30)) +
    theme(
      legend.position="none",
      axis.title.y = element_blank(),
      axis.ticks.y = element_blank(),
      axis.text.y = element_blank(),
      axis.line.y=element_blank(),
      panel.grid.major.y = element_line()
    ),
  graphObjectsLetter %>% get_legend,
  rel_widths = c(1.2,-.1,1,-.1,1,.3),
  nrow=1
) # %>% save_plot("ObjectsOthersLetters.svg",.,device="svg",base_aspect_ratio = 1.4, base_height = 6)


```




##################
### Objects-Nouns
##################

```{r Nouns within Block - Objects, options}

afex::set_effects_contrasts()

comparisonObjectsNouns <- dfTrials %>%
  filter(Inclusion) %>%
  filter(Block == "Objects" & primeSource %in% c("objects","noun")) %>%
  mixed(
    logRT ~ primeValence * targetCondition * primeSource + (1|targetWord) + (1|Subject),
    data = .,
    method = "S"
  )
comparisonObjectsNouns

```

                                    Effect         df         F p.value
1                             primeValence 1, 4061.93      2.47     .12
2                          targetCondition   1, 13.75    6.44 *     .02
3                              primeSource 1, 4061.28   9.14 **    .003
4             primeValence:targetCondition 1, 4067.89 30.97 ***  <.0001
5                 primeValence:primeSource 1, 4061.33      1.96     .16
6              targetCondition:primeSource 1, 4060.71    3.20 +     .07
7 primeValence:targetCondition:primeSource 1, 4061.71      0.18     .67

Here we have a main effect of primeSource, without the interaction on primeValence

```{r PrimeSource Contrasts - Objects, options}

comparisonObjectsNouns %>%
  emmeans(~primeSource) %>% contrast

```

The effect seems to be that objects are generally slower.

```{r Specific Contrasts - Objects, options}

emmeansObjectsNouns <- comparisonObjectsNouns %>%
  emmeans(~primeValence*targetCondition*primeSource)

contrastsObjectsNouns <- emmeansObjectsNouns %>%
  contrast(method="trt.vs.ctrlk") %>%
  as_tibble %>%
  separate(
    contrast,
    c("primeValenceA","targetValenceA","primeSourceA","primeValenceB","targetValenceB","primeSourceB")
  )

specificContrastsObjectsNouns <- contrastsObjectsNouns %>%
  filter(
    targetValenceA == targetValenceB,
    primeSourceA != primeSourceB,
    primeValenceA != targetValenceA
  ) %>%
  select(-targetValenceB)
specificContrastsObjectsNouns

```

Again, no differences between the incongruent trials between sources, and strong differences between incongruent objects and congruent nouns.



###################
### Full Model
###################


```{r Others Block, options}

afex::set_effects_contrasts()

fullOthers <- dfTrials %>%
  filter(Inclusion) %>%
  filter(Block == "Others") %>%
  mixed(
    logRT ~ primeCondition * targetCondition + (1|Subject) + (1|targetWord),
    data=.,
    method = "S",
  )

fullOthersEmmeans <- fullOthers %>%
  emmeans(~primeCondition*targetCondition)

```


```{r Objects Block, options}

afex::set_effects_contrasts()

fullObjects <- dfTrials %>%
  filter(Inclusion) %>%
  filter(Block == "Objects") %>%
  mixed(
    logRT ~ primeCondition * targetCondition + (1|Subject) + (1|targetWord),
    data=.,
    method = "S",
  )

fullObjectsEmmeans <- fullObjects %>%
  emmeans(~primeCondition*targetCondition)

```

```{r Graph Full Latencies, options}

fullOthersGraph <- fullOthersEmmeans %>%
  as_tibble %>%
  ggplot(aes(x=primeCondition %>% factor(levels = c("othersPos","othersNeg","nounPos","nounNeg","letterStr")),y=exp(emmean),fill=targetCondition)) +
  geom_col(position=position_dodge2()) +
  labs(x = "Prime Conditions", y = "RT (ms)", fill = "Target\nValence")

fullObjectsGraph <- fullObjectsEmmeans %>%
  as_tibble %>%
  ggplot(aes(x=primeCondition %>% factor(levels = c("objectsPos","objectsNeg","nounPos","nounNeg","letterStr")),y=exp(emmean),fill=targetCondition)) +
  geom_col(position=position_dodge2()) +
  labs(x = "Prime Conditions", y = "RT (ms)", fill = "Target\nValence")

plot_grid(
  fullOthersGraph,
  fullObjectsGraph,
  nrow=2
)

```

###################
## Delta Analyses
###################

For object primes: significant prime valence x target valence interaction: F(1,16) = 9.02, p < .008, eta² = .36

Liked significant other primes facilitated the processing of negative targets: t(37) = 2.24, p < .03
disliked significant other primes facilitated the processing of positive targets: t(37) = 2.08, p < .05

The overall facilitation effects (averaged across all combinations of prime and target valence) for significant other primes was significantly greater than for object primes:
 F(1,37) = 9.44, p < .005, eta² = .20.
 
Analyses of RTs on trials involving letter string primes revealed no main effect or interactions involving prime type.

The bivalent-priming effects triggered by significant other primes coexisted with the traditional prime valence x target valence interaction: F(1,21) = 10.32, p < .005, eta² = .33

```{r analyses Delta, options}

afex::set_effects_contrasts()

fitOthersDelta <- dfDelta %>%
  filter(Block == "Others") %>%
  mutate(
    primeCondition = primeCondition %>% factor(levels = c("othersPos","othersNeg","nounPos","nounNeg","letterStr"))
  ) %>%
  mixed(
    deltaRT ~ primeCondition * targetCondition +  (1|Key) + (1|firstBlock) + (1|firstValence) + (1|Subject) + (1|targetWord),
    data=.,
    method="S",
    check_contrasts = FALSE,
    contrasts = list(
      "primeCondition" = contr.SAS(5),
      "targetCondition" = contr.sum(2)
    )
  )

fitObjectsDelta <- dfDelta %>%
  filter(Block == "Objects") %>%
  mutate(
    primeCondition = primeCondition %>% factor(levels = c("objectsPos","objectsNeg","nounPos","nounNeg","letterStr"))
  ) %>%
  mixed(
    deltaRT ~ primeCondition * targetCondition +  (1|Key) + (1|firstBlock) + (1|firstValence) + (1|Subject) + (1|targetWord),
    data=.,
    method="S",
    check_contrasts = FALSE,
    contrast = list(
      "primeCondition" = contr.SAS(5),
      "targetCondition" = contr.sum(2)
    )
  )

```

```{r emmeans & contrast Delta, options}

emmOthersDelta <- fitOthersDelta %>%
  emmeans(~primeCondition * targetCondition)

contrOthersDelta <- emmOthersDelta %>%
  contrast(method="trt.vs.ctrlk",by = "targetCondition") %>%
  as_tibble %>%
  mutate(
    primeCondition = contrast %>% gsub("^([a-zA-Z]+).+$","\\1",.) %>% factor(levels = c("othersPos","othersNeg","nounPos","nounNeg")),
    targetCondition = rep(c("Positive","Negative"),each=4) %>% factor(levels = c("Positive","Negative")),
    p = case_when(
      p.value < .001 ~ "***",
      p.value < .01 ~ "**",
      p.value < .05 ~ "*",
      TRUE ~ p.value %>% signif(3) %>% as.character %>% gsub("^0\\.",".",.)
    )
  )

emmObjectsDelta <- fitObjectsDelta %>%
  emmeans(~primeCondition * targetCondition)

contrObjectsDelta <- emmObjectsDelta %>%
  contrast(method="trt.vs.ctrlk",by = "targetCondition") %>%
  as_tibble %>%
  mutate(
    primeCondition = contrast %>% gsub("^([a-zA-Z]+).+$","\\1",.) %>% factor(levels = c("objectsPos","objectsNeg","nounPos","nounNeg")),
    targetCondition = rep(c("Positive","Negative"),each=4) %>% factor(levels = c("Positive","Negative")),
    p = case_when(
      p.value < .001 ~ "***",
      p.value < .01 ~ "**",
      p.value < .05 ~ "*",
      TRUE ~ p.value %>% signif(3) %>% as.character %>% gsub("^0\\.",".",.)
    )
  )


```

```{r graphs Delta, options}


contrOthersDelta %>%
  ggplot(
    aes(x = primeCondition, y = estimate, fill = targetCondition, label = p)
  ) +
  geom_col(position=position_dodge2()) +
  labs(x = "Prime Conditions", y = "Latencies", fill = "Target\nValence") +
  geom_label(aes(y=0),position = position_dodge2(width = .9), fill = "white") +
  scale_y_continuous(limits = c(-70,25)) +
  theme(panel.grid.major.y = element_line())


contrObjectsDelta %>%
  ggplot(
    aes(x = primeCondition, y = estimate, fill = targetCondition, label = p)
  ) +
  geom_col(position=position_dodge2()) +
  labs(x = "Prime Conditions", y = "Latencies", fill = "Target\nValence") +
  geom_label(aes(y=0),position = position_dodge2(width = .9), fill = "white") +
  scale_y_continuous(limits = c(-70,25)) +
  theme(panel.grid.major.y = element_line())




# emmOthersDelta %>%
#   as_tibble %>%
#   filter(primeCondition != "letterStr") %>%
#   ggplot(aes(x = primeCondition %>% factor(levels = c("othersPos","othersNeg","nounPos","nounNeg")), y = emmean, ymin = asymp.LCL, ymax = asymp.UCL, fill = targetCondition)) +
#   geom_col(position=position_dodge2()) +
#   # geom_errorbar(position = position_dodge2()) +
#   geom_hline(yintercept=fitOthersDelta %>% summary %$% coefficients %>% extract2(1,1)) +
#   labs(x = "Prime Conditions", y = "Reaction Times", fill = "Target\nValence") +
#   # scale_y_continuous(limits = c(-70,25)) +
#   geom_label(
#     data = contrOthersDelta %>% filter(primeCondition != "letterStr"),
#     aes(x = primeCondition %>% factor(levels = c("othersPos","othersNeg","nounPos","nounNeg")), y = 0, label = p, fill = targetCondition %>% factor(levels = c("Pos","Neg"))),
#     position=position_dodge2(width = .9),
#     inherit.aes = FALSE
#   )
#   
# 
# emmObjectsDelta %>%
#   as_tibble %>%
#   filter(primeCondition != "letterStr") %>%
#   ggplot(aes(x = primeCondition %>% factor(levels = c("objectsPos","objectsNeg","nounPos","nounNeg")), y = emmean, ymin = asymp.LCL, ymax = asymp.UCL, fill = targetCondition)) +
#   geom_col(position=position_dodge2()) +
#   geom_errorbar(position = position_dodge2()) +
#   geom_hline(yintercept=fitObjectsDelta %>% summary %$% coefficients %>% extract2(1,1)) +
#   labs(x = "Prime Conditions", y = "Reaction Times", fill = "Target\nValence") +
#   # scale_y_continuous(limits = c(-70,25)) +
#   geom_label(
#     data = contrObjectsDelta %>% filter(primeCondition != "letterStr"),
#     aes(x = primeCondition %>% factor(levels = c("objectsPos","objectsNeg","nounPos","nounNeg")), y = 0, label = p, fill = targetCondition %>% factor(levels = c("Pos","Neg"))),
#     position=position_dodge2(width = .9),
#     inherit.aes = FALSE
#   )
  




```


####################
# Direct Measures
####################

```{r Visualisation Objects & Others, options}

dirPlot <- function(data,type){
  ggplot(data=data %>% filter(Type == type),aes(x=Positive,y=Negative,shape=Valence %>% factor(levels = c("Pos","Neg"), labels = c("Positive","Negative")),colour=Felt)) +
    geom_point(alpha=1,size=3) +
    labs(x="Positivity",y="Negativity") +
    guides(
      shape = guide_legend(title=paste0(type,"\nValence"),override.aes = list(alpha=1,size=5)),
      colour = guide_legend(title="Felt\nAmbivalence",override.aes = list(size=5))
    ) +
    scale_colour_gradient2(low = "black",mid = "orange",high="red",midpoint = 50) +
    scale_shape_manual(values=c(1,4)) +
    theme(plot.margin=margin(1.5,0.5,0.5,0.5,"cm"))
}

dfDirect %>%
  filter(subjExclusion %>% not) %>%
  dirPlot("Others")

dfDirect %>%
  filter(subjExclusion %>% not) %>%
  dirPlot("Objects")


```

```{r Levene's Test on Direct Measures between Valence, options}

multLevene <- function(data,type){
  data %>%
    filter(subjExclusion %>% not) %>%
    filter(Type == type) %>%
    mutate(Valence = Valence %>% factor(levels = c("Pos","Neg"))) %>%
    distinct(Subject,Valence,Felt,Positive,Negative,Griffin,Id) %$% {
      car::leveneTest(Felt ~ Valence) %>% print
      car::leveneTest(Positive ~ Valence) %>% print
      car::leveneTest(Negative ~ Valence) %>% print
      car::leveneTest(Griffin ~ Valence) %>% print
    }
}

dfDirect %>%
  multLevene("Others")

dfDirect %>%
  multLevene("Objects")

```

All tests show significance, rejecting the assumption that Positive and Negative Others/Objects have equal variance.
Based on the graphs, we can conclude that for both Others and Objects Positive items have lower variance.

```{r T.tests on Direct Measures between Valence, options}

multTtest <- function(data,type){
  data %>%
    filter(subjExclusion %>% not) %>%
    filter(Type == type) %>%
    mutate(Valence = Valence %>% factor(levels = c("Pos","Neg"))) %>%
    distinct(Subject,Valence,Felt,Positive,Negative,Griffin,Id) %$% {
      t.test(Felt ~ Valence) %>% print
      t.test(Positive ~ Valence) %>% print
      t.test(Negative ~ Valence) %>% print
      t.test(Griffin ~ Valence) %>% print
    }
}

dfDirect %>%
  multTtest("Others")

dfDirect %>%
  multTtest("Objects")

```

```{r Refactorisation primeCondition based on Direct Measures, options}

dfRefac <- dfDirect %>%
  right_join(
    dfTrials %>% filter(Segment == "experiment"),
    by = c("Name" = "primeWord", "Subject", "Condition","Key","firstBlock","firstValence","subjExclusion","nameExclusion")
  ) %>%
  mutate(
    primeDirect = case_when(
      Griffin > 0 ~ paste0(primeSource,"Amb"),
      Positive > Negative ~ paste0(primeSource,"Pos"),
      Negative > Positive ~ paste0(primeSource,"Neg"),
      TRUE ~ primeCondition %>% as.character
    ) %>% factor(levels = c("letterStr","otherAmb","otherPos","otherNeg","objectAmb","objectPos","objectNeg","nounPos","nounNeg"))
  )




df_others %>%
  distinct(Subject,otherNames,catGriff,otherDir,valDir) %>%
  spread(otherDir,valDir)  %>%
  right_join(
    df_trials,
    by = c("otherNames" = "Prime","Subject")
  ) %>%
  mutate(
    primeDirect = case_when( 
      catGriff == "Ambivalent" ~ "otherAmb",
      Pos > Neg ~ "otherPos",
      Neg > Pos ~ "otherNeg",
      TRUE ~ primeType %>% as.character
      # The most unclear thing here, is what we do with 'indifferent' participants
      # Currently, they get categorised as "univalent": otherPos or otherNeg, depending on the difference between the two direct measures Neg and Pos
      # In the case that these are equal, they get categorised as what they used to be before.
    ) %>% factor(levels = c("letterStr","otherAmb","otherPos","otherNeg","nounPos","nounNeg")),
    targetType = recode(targetType,"adjNeg" = "Neg", "adjPos" = "Pos") %>% factor(levels = c("Pos","Neg")),
    Subject = Subject %>% as.factor,
    Target = Target %>% as.factor,
    logRT = logRT %>% as.numeric()
  )

```



<!-- ####### -->
<!-- # OLD -->
<!-- ####### -->

<!-- Possibility: -->
<!-- set contrasts of the primeCondition to treatment (with the letter strings as base), but -->
<!-- with contrasts for targetCondition to [-1, 1] for Neg and Pos respectively. -->

<!-- ```{r Random Intercepts subject & target, options} -->

<!-- afex::set_effects_contrasts() -->
<!-- fitBoth1 <- dfTrials %>% -->
<!--   filter(Inclusion) %>% { -->
<!--     mixed( -->
<!--       logRT ~ primeCondition * targetCondition + Block + (1|targetWord) + (1|Subject), -->
<!--       data = ., -->
<!--       method = "S" -->
<!--     ) -->
<!--   } -->

<!-- afex::set_effects_contrasts() -->
<!-- fitBoth2 <- dfTrials %>% -->
<!--   filter(Inclusion) %>% { -->
<!--     mixed( -->
<!--       logRT ~ primeCondition * targetCondition + (1|Block) + (1|targetWord) + (1|Subject), -->
<!--       data = ., -->
<!--       method = "S" -->
<!--     ) -->
<!--   } -->

<!-- afex::set_effects_contrasts() -->
<!-- fitObj <- dfTrials %>% -->
<!--   filter(Inclusion & Block == "Objects") %>% { -->
<!--     mixed( -->
<!--       logRT ~ primeCondition * targetCondition + (1|targetWord) + (1|Subject), -->
<!--       data = ., -->
<!--       method = "S" -->
<!--     ) -->
<!--   } -->

<!-- afex::set_effects_contrasts() -->
<!-- fitOth <- dfTrials %>% -->
<!--   filter(Inclusion & Block == "Others") %>% { -->
<!--     mixed( -->
<!--       logRT ~ primeCondition * targetCondition + (1|targetWord) + (1|Subject), -->
<!--       data = ., -->
<!--       method = "S" -->
<!--     ) -->
<!--   } -->


<!-- ``` -->

<!-- ```{r Estimated Means, options} -->

<!-- emmeansFull1 <- fitBoth1 %>% emmeans(~primeCondition * targetCondition + Block) -->

<!-- emmeansFull2 <- fitBoth2 %>% emmeans(~primeCondition * targetCondition) -->

<!-- emmeansObj <- fitObj %>% emmeans(~primeCondition * targetCondition) -->

<!-- emmeansOth <- fitOth %>% emmeans(~primeCondition * targetCondition) -->

<!-- ``` -->

<!-- ```{r Contrasts, options} -->

<!-- contrFull1 <- emmeansFull1 %>% -->
<!--   contrast(method="revpairwise") %>% -->
<!--   as_tibble %>% -->
<!--   separate(contrast,c("contrastA","contrastB"),sep=" - ") %>% -->
<!--   separate(contrastA,c("primeA","targetA","blockA"),sep=",") %>% -->
<!--   separate(contrastB,c("primeB","targetB","blockB"),sep=",") %>% -->
<!--   mutate_at( -->
<!--     vars(primeA,primeB), -->
<!--     funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE))) -->
<!--   ) %>% -->
<!--   mutate_at( -->
<!--     vars(targetA,targetB), -->
<!--     funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE))) -->
<!--   ) %>% -->
<!--   arrange(blockA,blockB,primeA %>% desc,primeB %>% desc,targetA) -->

<!-- contrFull2 <- emmeansFull2 %>% -->
<!--   contrast(method="revpairwise") %>% -->
<!--   as_tibble %>% -->
<!--   separate(contrast,c("contrastA","contrastB"),sep=" - ") %>% -->
<!--   separate(contrastA,c("primeA","targetA"),sep=",") %>% -->
<!--   separate(contrastB,c("primeB","targetB"),sep=",") %>% -->
<!--   mutate_at( -->
<!--     vars(primeA,primeB), -->
<!--     funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE))) -->
<!--   ) %>% -->
<!--   mutate_at( -->
<!--     vars(targetA,targetB), -->
<!--     funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE))) -->
<!--   ) %>% -->
<!--   arrange(primeA %>% desc,primeB %>% desc,targetA) -->

<!-- contrObj <- emmeansObj %>% -->
<!--   contrast(method="pairwise") %>% -->
<!--   as_tibble %>% -->
<!--   separate(contrast,c("contrastA","contrastB"),sep=" - ") %>% -->
<!--   separate(contrastA,c("primeA","targetA"),sep=",") %>% -->
<!--   separate(contrastB,c("primeB","targetB"),sep=",") %>% -->
<!--   mutate_at( -->
<!--     vars(primeA,primeB), -->
<!--     funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE))) -->
<!--   ) %>% -->
<!--   mutate_at( -->
<!--     vars(targetA,targetB), -->
<!--     funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE))) -->
<!--   ) %>% -->
<!--   arrange(primeA,primeB,targetA) -->

<!-- contrOth <- emmeansOth %>% -->
<!--   contrast(method="pairwise") %>% -->
<!--   as_tibble %>% -->
<!--   separate(contrast,c("contrastA","contrastB"),sep=" - ") %>% -->
<!--   separate(contrastA,c("primeA","targetA"),sep=",") %>% -->
<!--   separate(contrastB,c("primeB","targetB"),sep=",") %>% -->
<!--   mutate_at( -->
<!--     vars(primeA,primeB), -->
<!--     funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE))) -->
<!--   ) %>% -->
<!--   mutate_at( -->
<!--     vars(targetA,targetB), -->
<!--     funs(factor(.,levels=unique(.) %>% sort(decreasing=TRUE))) -->
<!--   ) %>% -->
<!--   arrange(primeA,primeB,targetA) -->

<!-- ``` -->

<!-- ############# -->
<!-- ### Graphs -->
<!-- ############# -->

<!-- ```{r Emmeans Others & Objects, options} -->

<!-- plot_grid( -->
<!--   emmeansOth %>% -->
<!--     as_tibble %>% -->
<!--     mutate_at( -->
<!--       vars(emmean,asymp.LCL,asymp.UCL), -->
<!--       exp -->
<!--     ) %>% -->
<!--     mutate( -->
<!--       primeCondition = primeCondition %>% -->
<!--         as.factor %>% -->
<!--         factor(levels = levels(.) %>% rev) -->
<!--     ) %>% -->
<!--     ggplot(aes(x = primeCondition, y = emmean, fill = targetCondition, ymin = asymp.LCL, ymax = asymp.UCL)) + -->
<!--     geom_col(position=position_dodge2()) + -->
<!--     labs(x="Prime Conditions",y="Latency (ms)",title=paste("Comparison Estimated Mean Latency for the Others Block")) + -->
<!--     guides(fill = guide_legend(title="Target\nValence")) + -->
<!--     scale_fill_discrete(labels=c("Positive","Negative")) + -->
<!--     geom_errorbar(position = position_dodge2(padding=.8),colour = "black",size=.5) + -->
<!--     geom_label( -->
<!--       data = contrOth %>% -->
<!--         filter(primeA == primeB), -->
<!--       aes( -->
<!--         x = primeA, -->
<!--         y = 10, -->
<!--         label = p.value %>% signif(3) -->
<!--       ), -->
<!--       inherit.aes = FALSE -->
<!--     ) + -->
<!--     theme_bw(), -->
<!--   emmeansObj %>% -->
<!--     as_tibble %>% -->
<!--     mutate_at( -->
<!--       vars(emmean,asymp.LCL,asymp.UCL), -->
<!--       exp -->
<!--     ) %>% -->
<!--     mutate( -->
<!--       primeCondition = primeCondition %>% -->
<!--         as.factor %>% -->
<!--         factor(levels = levels(.) %>% rev) -->
<!--     ) %>% -->
<!--     ggplot(aes(x = primeCondition, y = emmean, fill = targetCondition, ymin = asymp.LCL, ymax = asymp.UCL)) + -->
<!--     geom_col(position=position_dodge2()) + -->
<!--     labs(x="Prime Conditions",y="Latency (ms)",title=paste("Comparison Estimated Mean Latency for the Objects Block")) + -->
<!--     guides(fill = guide_legend(title="Target\nValence")) + -->
<!--     scale_fill_discrete(labels=c("Positive","Negative")) + -->
<!--     geom_errorbar(position = position_dodge2(padding=.8),colour = "black",size=.5) + -->
<!--     geom_label( -->
<!--       data = contrObj %>% -->
<!--         filter(primeA == primeB), -->
<!--       aes( -->
<!--         x = primeA, -->
<!--         y = 10, -->
<!--         label = p.value %>% signif(3) -->
<!--       ), -->
<!--       inherit.aes = FALSE -->
<!--     ) + -->
<!--     theme_bw(), -->
<!--   ncol = 1, -->
<!--   align = "hv" -->
<!-- ) -->

<!-- ``` -->

<!-- ```{r Comparison Others & Objects, options} -->

<!-- contrFull2 %>% -->
<!--   filter( -->
<!--     grepl("others.",primeA) & grepl("objects.",primeB) & targetA == targetB -->
<!--   ) %>%  -->
<!--   group_by(primeA,primeB) %>% -->
<!--   do( -->
<!--     plots = ggplot(data=.,aes(x=primeA,y=estimate,fill=targetA)) + -->
<!--       geom_col(position=position_dodge2()) + -->
<!--       ggtitle(paste(.$primeA,"-",.$primeB)) + -->
<!--       labs(x="",y="") + -->
<!--       scale_x_discrete(labels = NULL, breaks = NULL) + -->
<!--       scale_y_continuous(limits=c(-.08,.08)) + -->
<!--       geom_label( -->
<!--          aes( -->
<!--            y=0, -->
<!--           label=case_when( -->
<!--             p.value < .001 ~ '***', -->
<!--             p.value < .01 ~ '**', -->
<!--             p.value < .05 ~ '*', -->
<!--             TRUE ~ signif(p.value,3) %>% as.character -->
<!--           ) -->
<!--       ), -->
<!--       position = position_dodge2(width=.9), -->
<!--       show.legend=FALSE -->
<!--       ) -->
<!--   ) %$%  -->
<!--   plot_grid( -->
<!--     plot_grid( -->
<!--       plots[[1]] + -->
<!--         theme(legend.position="none"), -->
<!--       plots[[2]] + -->
<!--         theme(legend.position="none"), -->
<!--       plots[[3]] + -->
<!--         theme(legend.position="none"), -->
<!--       plots[[4]] + -->
<!--         theme(legend.position="none"), -->
<!--       align="hv",nrow=2 -->
<!--     ), -->
<!--     get_legend(plots[[1]]), -->
<!--     nrow=1, -->
<!--     rel_widths = c(1,.2) -->
<!--   ) -->


<!-- ``` -->


<!-- ```{r Graphs, options} -->

<!-- # contrFull1 %>% -->
<!-- #   filter( -->
<!-- #     targetA == targetB & -->
<!-- #       blockA == blockB -->
<!-- #   ) %>% -->
<!-- #   filter( -->
<!-- #     grepl("(others|objects).",primeA) | -->
<!-- #       grepl("(others|objects).",primeB) -->
<!-- #   ) %>% -->
<!-- #   filter( -->
<!-- #     (blockA == "Objects" & not(grepl("others.",primeA))) | -->
<!-- #       (blockB == "Objects" & not(grepl("others.",primeB))) -->
<!-- #   ) %>% -->
<!-- #   group_by(blockA,primeA,primeB) %>% -->
<!-- #   do( -->
<!-- #     plots = ggplot(data=.,aes(x=primeA,y=estimate,fill=targetA)) + -->
<!-- #       geom_col(position=position_dodge2()) + -->
<!-- #       ggtitle(paste(.$primeA,"-",.$primeB)) + -->
<!-- #       labs(x="",y="") + -->
<!-- #       scale_x_discrete(labels = NULL, breaks = NULL) + -->
<!-- #       scale_y_continuous() + -->
<!-- #       geom_label( -->
<!-- #          aes( -->
<!-- #           label=case_when( -->
<!-- #             p.value < .001 ~ '***', -->
<!-- #             p.value < .01 ~ '**', -->
<!-- #             p.value < .05 ~ '*', -->
<!-- #             TRUE ~ NA_character_ -->
<!-- #           ) -->
<!-- #       ), -->
<!-- #       position = position_dodge2(width=.9) -->
<!-- #       ) + -->
<!-- #       theme_bw(legend.position="none") -->
<!-- #   ) %$% -->
<!-- #   plot_grid( -->
<!-- #     plotlist=plots,align="hv" -->
<!-- #   ) -->


<!-- ``` -->